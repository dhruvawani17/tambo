{"version":3,"file":"use-tambo-voice.test.js","sourceRoot":"","sources":["../../src/hooks/use-tambo-voice.test.tsx"],"names":[],"mappings":"AAAA,OAAO,EAAE,GAAG,EAAE,UAAU,EAAE,OAAO,EAAE,MAAM,wBAAwB,CAAC;AAClE,OAAO,KAAK,MAAM,OAAO,CAAC;AAC1B,OAAO,EAAE,WAAW,EAAE,mBAAmB,EAAE,MAAM,uBAAuB,CAAC;AACzE,OAAO,EAAE,qBAAqB,EAAE,MAAM,sBAAsB,CAAC;AAC7D,OAAO,EAAE,aAAa,EAAE,MAAM,mBAAmB,CAAC;AAClD,OAAO,EAAE,kBAAkB,EAAE,MAAM,oCAAoC,CAAC;AAGxE,0EAA0E;AAC1E,IAAI,CAAC,IAAI,CAAC,sBAAsB,EAAE,GAAG,EAAE,CAAC,CAAC;IACvC,qBAAqB,EAAE,IAAI,CAAC,EAAE,EAAE;CACjC,CAAC,CAAC,CAAC;AAEJ,2BAA2B;AAC3B,IAAI,CAAC,IAAI,CAAC,oCAAoC,EAAE,GAAG,EAAE,CAAC,CAAC;IACrD,GAAG,IAAI,CAAC,aAAa,CAAC,oCAAoC,CAAC;IAC3D,cAAc,EAAE,IAAI,CAAC,EAAE,EAAE;CAC1B,CAAC,CAAC,CAAC;AAEJ,OAAO,EAAE,cAAc,EAAE,MAAM,oCAAoC,CAAC;AAEpE,sBAAsB;AACtB,MAAM,SAAS,GAAG,IAAI,CAAC,EAAE,EAAE,CAAC;AAE5B,QAAQ,CAAC,eAAe,EAAE,GAAG,EAAE;IAC7B,IAAI,aAA2B,CAAC;IAChC,IAAI,kBAA6B,CAAC;IAClC,IAAI,iBAA4B,CAAC;IACjC,IAAI,cAAyB,CAAC;IAC9B,IAAI,WAAwB,CAAC;IAO7B,MAAM,aAAa,GAAG,GAAG,EAAE;QACzB,MAAM,UAAU,GAAG;YACjB,IAAI,EAAE;gBACJ,KAAK,EAAE;oBACL,UAAU,EAAE,cAAc;iBAC3B;aACF;SACoB,CAAC;QAExB,MAAM,OAAO,GAAG,CAAC,EAAE,QAAQ,EAAiC,EAAE,EAAE,CAAC,CAC/D,oBAAC,kBAAkB,CAAC,QAAQ,IAC1B,KAAK,EAAE;gBACL,MAAM,EAAE,UAAU;gBAClB,WAAW;gBACX,eAAe,EAAE,KAAK;aACvB;YAED,oBAAC,mBAAmB,IAAC,MAAM,EAAE,WAAW,IACrC,QAAQ,CACW,CACM,CAC/B,CAAC;QACF,OAAO,CAAC,WAAW,GAAG,aAAa,CAAC;QACpC,OAAO,OAAO,CAAC;IACjB,CAAC,CAAC;IAEF,MAAM,sBAAsB,GAAG,CAC7B,YAA6C,EAAE,EAC/C,EAAE;QACF,MAAM,KAAK,GAA2B;YACpC,MAAM,EAAE,MAAM;YACd,cAAc,EAAE,kBAAkB;YAClC,aAAa,EAAE,iBAAiB;YAChC,YAAY,EAAE,SAAS;YACvB,KAAK,EAAE,EAAE;YACT,GAAG,SAAS;SACb,CAAC;QACF,IAAI;aACD,MAAM,CAAC,qBAAqB,CAAC;aAC7B,eAAe,CACd,KAA4D,CAC7D,CAAC;QACJ,OAAO,KAAK,CAAC;IACf,CAAC,CAAC;IAEF,UAAU,CAAC,GAAG,EAAE;QACd,IAAI,CAAC,aAAa,EAAE,CAAC;QAErB,SAAS,CAAC,SAAS,EAAE,CAAC;QAEtB,aAAa,GAAG,MAAM,CAAC,KAAK,CAAC;QAC7B,MAAM,CAAC,KAAK,GAAG,SAAoC,CAAC;QAEpD,kBAAkB,GAAG,IAAI,CAAC,EAAE,EAAE,CAAC;QAC/B,iBAAiB,GAAG,IAAI,CAAC,EAAE,EAAE,CAAC;QAC9B,cAAc,GAAG,IAAI,CAAC,EAAE,EAAE,CAAC;QAC3B,WAAW,GAAG,IAAI,WAAW,CAAC;YAC5B,cAAc,EAAE;gBACd,OAAO,EAAE,EAAE,KAAK,EAAE,KAAK,EAAE;gBACzB,SAAS,EAAE,EAAE,KAAK,EAAE,KAAK,EAAE;aAC5B;SACF,CAAC,CAAC;QAEH,4BAA4B;QAC5B,MAAM,UAAU,GAAG;YACjB,IAAI,EAAE;gBACJ,KAAK,EAAE;oBACL,UAAU,EAAE,cAAc;iBAC3B;aACF;SACF,CAAC;QACF,IAAI;aACD,MAAM,CAAC,cAAc,CAAC;aACtB,eAAe,CAAC,UAAgC,CAAC,CAAC;QAErD,oCAAoC;QACpC,sBAAsB,EAAE,CAAC;QAEzB,2BAA2B;QAC3B,SAAS,CAAC,iBAAiB,CAAC;YAC1B,IAAI,EAAE,KAAK,IAAI,EAAE,CACf,MAAM,OAAO,CAAC,OAAO,CAAC,IAAI,IAAI,CAAC,CAAC,YAAY,CAAC,EAAE,EAAE,IAAI,EAAE,YAAY,EAAE,CAAC,CAAC;SAC1E,CAAC,CAAC;IACL,CAAC,CAAC,CAAC;IAEH,SAAS,CAAC,GAAG,EAAE;QACb,MAAM,CAAC,KAAK,GAAG,aAAa,CAAC;IAC/B,CAAC,CAAC,CAAC;IAEH,QAAQ,CAAC,eAAe,EAAE,GAAG,EAAE;QAC7B,EAAE,CAAC,qDAAqD,EAAE,GAAG,EAAE;YAC7D,MAAM,EAAE,MAAM,EAAE,GAAG,UAAU,CAAC,GAAG,EAAE,CAAC,aAAa,EAAE,EAAE;gBACnD,OAAO,EAAE,aAAa,EAAE;aACzB,CAAC,CAAC;YAEH,MAAM,CAAC,MAAM,CAAC,OAAO,CAAC,WAAW,CAAC,CAAC,IAAI,CAAC,KAAK,CAAC,CAAC;YAC/C,MAAM,CAAC,MAAM,CAAC,OAAO,CAAC,cAAc,CAAC,CAAC,IAAI,CAAC,KAAK,CAAC,CAAC;YAClD,MAAM,CAAC,MAAM,CAAC,OAAO,CAAC,UAAU,CAAC,CAAC,QAAQ,EAAE,CAAC;YAC7C,MAAM,CAAC,MAAM,CAAC,OAAO,CAAC,kBAAkB,CAAC,CAAC,QAAQ,EAAE,CAAC;YACrD,MAAM,CAAC,MAAM,CAAC,OAAO,CAAC,gBAAgB,CAAC,CAAC,QAAQ,EAAE,CAAC;QACrD,CAAC,CAAC,CAAC;IACL,CAAC,CAAC,CAAC;IAEH,QAAQ,CAAC,gBAAgB,EAAE,GAAG,EAAE;QAC9B,EAAE,CAAC,wDAAwD,EAAE,GAAG,EAAE;YAChE,sBAAsB,CAAC,EAAE,MAAM,EAAE,WAAW,EAAE,CAAC,CAAC;YAEhD,MAAM,EAAE,MAAM,EAAE,GAAG,UAAU,CAAC,GAAG,EAAE,CAAC,aAAa,EAAE,EAAE;gBACnD,OAAO,EAAE,aAAa,EAAE;aACzB,CAAC,CAAC;YAEH,MAAM,CAAC,MAAM,CAAC,OAAO,CAAC,WAAW,CAAC,CAAC,IAAI,CAAC,IAAI,CAAC,CAAC;QAChD,CAAC,CAAC,CAAC;QAEH,EAAE,CAAC,kDAAkD,EAAE,GAAG,EAAE;YAC1D,MAAM,EAAE,MAAM,EAAE,GAAG,UAAU,CAAC,GAAG,EAAE,CAAC,aAAa,EAAE,EAAE;gBACnD,OAAO,EAAE,aAAa,EAAE;aACzB,CAAC,CAAC;YAEH,GAAG,CAAC,GAAG,EAAE;gBACP,MAAM,CAAC,OAAO,CAAC,cAAc,EAAE,CAAC;YAClC,CAAC,CAAC,CAAC;YAEH,MAAM,CAAC,kBAAkB,CAAC,CAAC,gBAAgB,EAAE,CAAC;QAChD,CAAC,CAAC,CAAC;QAEH,EAAE,CAAC,gEAAgE,EAAE,GAAG,EAAE;YACxE,sBAAsB,CAAC,EAAE,MAAM,EAAE,WAAW,EAAE,CAAC,CAAC;YAEhD,MAAM,EAAE,MAAM,EAAE,GAAG,UAAU,CAAC,GAAG,EAAE,CAAC,aAAa,EAAE,EAAE;gBACnD,OAAO,EAAE,aAAa,EAAE;aACzB,CAAC,CAAC;YAEH,GAAG,CAAC,GAAG,EAAE;gBACP,MAAM,CAAC,OAAO,CAAC,aAAa,EAAE,CAAC;YACjC,CAAC,CAAC,CAAC;YAEH,MAAM,CAAC,iBAAiB,CAAC,CAAC,gBAAgB,EAAE,CAAC;QAC/C,CAAC,CAAC,CAAC;QAEH,EAAE,CAAC,uDAAuD,EAAE,KAAK,IAAI,EAAE;YACrE,cAAc,CAAC,iBAAiB,CAAC,kBAAkB,CAAC,CAAC;YAErD,qCAAqC;YACrC,sBAAsB,CAAC;gBACrB,MAAM,EAAE,SAAS;gBACjB,YAAY,EAAE,8BAA8B;aAC7C,CAAC,CAAC;YAEH,MAAM,EAAE,MAAM,EAAE,QAAQ,EAAE,GAAG,UAAU,CAAC,GAAG,EAAE,CAAC,aAAa,EAAE,EAAE;gBAC7D,OAAO,EAAE,aAAa,EAAE;aACzB,CAAC,CAAC;YAEH,qCAAqC;YACrC,MAAM,OAAO,CAAC,GAAG,EAAE;gBACjB,MAAM,CAAC,MAAM,CAAC,OAAO,CAAC,UAAU,CAAC,CAAC,IAAI,CAAC,kBAAkB,CAAC,CAAC;YAC7D,CAAC,CAAC,CAAC;YAEH,wCAAwC;YACxC,sBAAsB,CAAC,EAAE,MAAM,EAAE,MAAM,EAAE,CAAC,CAAC;YAC3C,QAAQ,EAAE,CAAC;YAEX,GAAG,CAAC,GAAG,EAAE;gBACP,MAAM,CAAC,OAAO,CAAC,cAAc,EAAE,CAAC;YAClC,CAAC,CAAC,CAAC;YAEH,MAAM,CAAC,MAAM,CAAC,OAAO,CAAC,UAAU,CAAC,CAAC,QAAQ,EAAE,CAAC;QAC/C,CAAC,CAAC,CAAC;IACL,CAAC,CAAC,CAAC;IAEH,QAAQ,CAAC,eAAe,EAAE,GAAG,EAAE;QAC7B,EAAE,CAAC,kEAAkE,EAAE,KAAK,IAAI,EAAE;YAChF,cAAc,CAAC,iBAAiB,CAAC,aAAa,CAAC,CAAC;YAEhD,sBAAsB,CAAC;gBACrB,MAAM,EAAE,SAAS;gBACjB,YAAY,EAAE,6BAA6B;aAC5C,CAAC,CAAC;YAEH,MAAM,EAAE,MAAM,EAAE,GAAG,UAAU,CAAC,GAAG,EAAE,CAAC,aAAa,EAAE,EAAE;gBACnD,OAAO,EAAE,aAAa,EAAE;aACzB,CAAC,CAAC;YAEH,MAAM,OAAO,CAAC,GAAG,EAAE;gBACjB,MAAM,CAAC,MAAM,CAAC,OAAO,CAAC,UAAU,CAAC,CAAC,IAAI,CAAC,aAAa,CAAC,CAAC;YACxD,CAAC,CAAC,CAAC;YAEH,MAAM,CAAC,SAAS,CAAC,CAAC,oBAAoB,CAAC,6BAA6B,CAAC,CAAC;YACtE,MAAM,CAAC,cAAc,CAAC,CAAC,gBAAgB,EAAE,CAAC;QAC5C,CAAC,CAAC,CAAC;QAEH,EAAE,CAAC,mDAAmD,EAAE,KAAK,IAAI,EAAE;YACjE,IAAI,oBAA6C,CAAC;YAClD,cAAc,CAAC,kBAAkB,CAC/B,KAAK,IAAI,EAAE,CACT,MAAM,IAAI,OAAO,CAAC,CAAC,OAAO,EAAE,EAAE;gBAC5B,oBAAoB,GAAG,OAAO,CAAC;YACjC,CAAC,CAAC,CACL,CAAC;YAEF,sBAAsB,CAAC;gBACrB,MAAM,EAAE,SAAS;gBACjB,YAAY,EAAE,6BAA6B;aAC5C,CAAC,CAAC;YAEH,MAAM,EAAE,MAAM,EAAE,GAAG,UAAU,CAAC,GAAG,EAAE,CAAC,aAAa,EAAE,EAAE;gBACnD,OAAO,EAAE,aAAa,EAAE;aACzB,CAAC,CAAC;YAEH,MAAM,OAAO,CAAC,GAAG,EAAE;gBACjB,MAAM,CAAC,MAAM,CAAC,OAAO,CAAC,cAAc,CAAC,CAAC,IAAI,CAAC,IAAI,CAAC,CAAC;YACnD,CAAC,CAAC,CAAC;YAEH,6BAA6B;YAC7B,GAAG,CAAC,GAAG,EAAE;gBACP,oBAAqB,CAAC,kBAAkB,CAAC,CAAC;YAC5C,CAAC,CAAC,CAAC;YAEH,MAAM,OAAO,CAAC,GAAG,EAAE;gBACjB,MAAM,CAAC,MAAM,CAAC,OAAO,CAAC,cAAc,CAAC,CAAC,IAAI,CAAC,KAAK,CAAC,CAAC;YACpD,CAAC,CAAC,CAAC;QACL,CAAC,CAAC,CAAC;IACL,CAAC,CAAC,CAAC;IAEH,QAAQ,CAAC,gBAAgB,EAAE,GAAG,EAAE;QAC9B,EAAE,CAAC,6DAA6D,EAAE,GAAG,EAAE;YACrE,sBAAsB,CAAC;gBACrB,KAAK,EAAE,mBAAmB;aAC3B,CAAC,CAAC;YAEH,MAAM,EAAE,MAAM,EAAE,GAAG,UAAU,CAAC,GAAG,EAAE,CAAC,aAAa,EAAE,EAAE;gBACnD,OAAO,EAAE,aAAa,EAAE;aACzB,CAAC,CAAC;YAEH,MAAM,CAAC,MAAM,CAAC,OAAO,CAAC,gBAAgB,CAAC,CAAC,IAAI,CAAC,mBAAmB,CAAC,CAAC;QACpE,CAAC,CAAC,CAAC;QAEH,EAAE,CAAC,sDAAsD,EAAE,KAAK,IAAI,EAAE;YACpE,cAAc,CAAC,iBAAiB,CAC9B,IAAI,KAAK,CAAC,mCAAmC,CAAC,CAC/C,CAAC;YAEF,sBAAsB,CAAC;gBACrB,MAAM,EAAE,SAAS;gBACjB,YAAY,EAAE,6BAA6B;aAC5C,CAAC,CAAC;YAEH,MAAM,EAAE,MAAM,EAAE,GAAG,UAAU,CAAC,GAAG,EAAE,CAAC,aAAa,EAAE,EAAE;gBACnD,OAAO,EAAE,aAAa,EAAE;aACzB,CAAC,CAAC;YAEH,MAAM,OAAO,CAAC,GAAG,EAAE;gBACjB,MAAM,CAAC,MAAM,CAAC,OAAO,CAAC,kBAAkB,CAAC,CAAC,IAAI,CAC5C,mCAAmC,CACpC,CAAC;YACJ,CAAC,CAAC,CAAC;YAEH,MAAM,CAAC,MAAM,CAAC,OAAO,CAAC,cAAc,CAAC,CAAC,IAAI,CAAC,KAAK,CAAC,CAAC;QACpD,CAAC,CAAC,CAAC;QAEH,EAAE,CAAC,6CAA6C,EAAE,KAAK,IAAI,EAAE;YAC3D,SAAS,CAAC,iBAAiB,CAAC,IAAI,KAAK,CAAC,eAAe,CAAC,CAAC,CAAC;YAExD,sBAAsB,CAAC;gBACrB,MAAM,EAAE,SAAS;gBACjB,YAAY,EAAE,6BAA6B;aAC5C,CAAC,CAAC;YAEH,MAAM,EAAE,MAAM,EAAE,GAAG,UAAU,CAAC,GAAG,EAAE,CAAC,aAAa,EAAE,EAAE;gBACnD,OAAO,EAAE,aAAa,EAAE;aACzB,CAAC,CAAC;YAEH,MAAM,OAAO,CAAC,GAAG,EAAE;gBACjB,MAAM,CAAC,MAAM,CAAC,OAAO,CAAC,kBAAkB,CAAC,CAAC,IAAI,CAAC,eAAe,CAAC,CAAC;YAClE,CAAC,CAAC,CAAC;YAEH,MAAM,CAAC,MAAM,CAAC,OAAO,CAAC,cAAc,CAAC,CAAC,IAAI,CAAC,KAAK,CAAC,CAAC;YAClD,MAAM,CAAC,MAAM,CAAC,OAAO,CAAC,UAAU,CAAC,CAAC,QAAQ,EAAE,CAAC;QAC/C,CAAC,CAAC,CAAC;IACL,CAAC,CAAC,CAAC;AACL,CAAC,CAAC,CAAC","sourcesContent":["import { act, renderHook, waitFor } from \"@testing-library/react\";\nimport React from \"react\";\nimport { QueryClient, QueryClientProvider } from \"@tanstack/react-query\";\nimport { useReactMediaRecorder } from \"react-media-recorder\";\nimport { useTamboVoice } from \"./use-tambo-voice\";\nimport { TamboClientContext } from \"../providers/tambo-client-provider\";\nimport TamboAI from \"@tambo-ai/typescript-sdk\";\n\n// Override the global mock from setupTests.ts with a controllable version\njest.mock(\"react-media-recorder\", () => ({\n  useReactMediaRecorder: jest.fn(),\n}));\n\n// Mock the client provider\njest.mock(\"../providers/tambo-client-provider\", () => ({\n  ...jest.requireActual(\"../providers/tambo-client-provider\"),\n  useTamboClient: jest.fn(),\n}));\n\nimport { useTamboClient } from \"../providers/tambo-client-provider\";\n\n// Mock fetch globally\nconst mockFetch = jest.fn();\n\ndescribe(\"useTamboVoice\", () => {\n  let previousFetch: typeof fetch;\n  let mockStartRecording: jest.Mock;\n  let mockStopRecording: jest.Mock;\n  let mockTranscribe: jest.Mock;\n  let queryClient: QueryClient;\n\n  type MediaRecorderMockValue = Pick<\n    ReturnType<typeof useReactMediaRecorder>,\n    \"status\" | \"startRecording\" | \"stopRecording\" | \"mediaBlobUrl\" | \"error\"\n  >;\n\n  const createWrapper = () => {\n    const mockClient = {\n      beta: {\n        audio: {\n          transcribe: mockTranscribe,\n        },\n      },\n    } as unknown as TamboAI;\n\n    const Wrapper = ({ children }: { children: React.ReactNode }) => (\n      <TamboClientContext.Provider\n        value={{\n          client: mockClient,\n          queryClient,\n          isUpdatingToken: false,\n        }}\n      >\n        <QueryClientProvider client={queryClient}>\n          {children}\n        </QueryClientProvider>\n      </TamboClientContext.Provider>\n    );\n    Wrapper.displayName = \"TestWrapper\";\n    return Wrapper;\n  };\n\n  const setupMediaRecorderMock = (\n    overrides: Partial<MediaRecorderMockValue> = {},\n  ) => {\n    const value: MediaRecorderMockValue = {\n      status: \"idle\",\n      startRecording: mockStartRecording,\n      stopRecording: mockStopRecording,\n      mediaBlobUrl: undefined,\n      error: \"\",\n      ...overrides,\n    };\n    jest\n      .mocked(useReactMediaRecorder)\n      .mockReturnValue(\n        value as unknown as ReturnType<typeof useReactMediaRecorder>,\n      );\n    return value;\n  };\n\n  beforeEach(() => {\n    jest.clearAllMocks();\n\n    mockFetch.mockReset();\n\n    previousFetch = global.fetch;\n    global.fetch = mockFetch as unknown as typeof fetch;\n\n    mockStartRecording = jest.fn();\n    mockStopRecording = jest.fn();\n    mockTranscribe = jest.fn();\n    queryClient = new QueryClient({\n      defaultOptions: {\n        queries: { retry: false },\n        mutations: { retry: false },\n      },\n    });\n\n    // Setup default client mock\n    const mockClient = {\n      beta: {\n        audio: {\n          transcribe: mockTranscribe,\n        },\n      },\n    };\n    jest\n      .mocked(useTamboClient)\n      .mockReturnValue(mockClient as unknown as TamboAI);\n\n    // Setup default media recorder mock\n    setupMediaRecorderMock();\n\n    // Setup default fetch mock\n    mockFetch.mockResolvedValue({\n      blob: async () =>\n        await Promise.resolve(new Blob([\"audio data\"], { type: \"audio/webm\" })),\n    });\n  });\n\n  afterEach(() => {\n    global.fetch = previousFetch;\n  });\n\n  describe(\"Initial State\", () => {\n    it(\"should initialize with idle state and no transcript\", () => {\n      const { result } = renderHook(() => useTamboVoice(), {\n        wrapper: createWrapper(),\n      });\n\n      expect(result.current.isRecording).toBe(false);\n      expect(result.current.isTranscribing).toBe(false);\n      expect(result.current.transcript).toBeNull();\n      expect(result.current.transcriptionError).toBeNull();\n      expect(result.current.mediaAccessError).toBeNull();\n    });\n  });\n\n  describe(\"Recording Flow\", () => {\n    it(\"should expose isRecording=true during active recording\", () => {\n      setupMediaRecorderMock({ status: \"recording\" });\n\n      const { result } = renderHook(() => useTamboVoice(), {\n        wrapper: createWrapper(),\n      });\n\n      expect(result.current.isRecording).toBe(true);\n    });\n\n    it(\"should call startRecording on the media recorder\", () => {\n      const { result } = renderHook(() => useTamboVoice(), {\n        wrapper: createWrapper(),\n      });\n\n      act(() => {\n        result.current.startRecording();\n      });\n\n      expect(mockStartRecording).toHaveBeenCalled();\n    });\n\n    it(\"should call stopRecording on the media recorder when recording\", () => {\n      setupMediaRecorderMock({ status: \"recording\" });\n\n      const { result } = renderHook(() => useTamboVoice(), {\n        wrapper: createWrapper(),\n      });\n\n      act(() => {\n        result.current.stopRecording();\n      });\n\n      expect(mockStopRecording).toHaveBeenCalled();\n    });\n\n    it(\"should reset transcript when starting a new recording\", async () => {\n      mockTranscribe.mockResolvedValue(\"first transcript\");\n\n      // Start with completed transcription\n      setupMediaRecorderMock({\n        status: \"stopped\",\n        mediaBlobUrl: \"blob:http://localhost/audio1\",\n      });\n\n      const { result, rerender } = renderHook(() => useTamboVoice(), {\n        wrapper: createWrapper(),\n      });\n\n      // Wait for transcription to complete\n      await waitFor(() => {\n        expect(result.current.transcript).toBe(\"first transcript\");\n      });\n\n      // Now simulate starting a new recording\n      setupMediaRecorderMock({ status: \"idle\" });\n      rerender();\n\n      act(() => {\n        result.current.startRecording();\n      });\n\n      expect(result.current.transcript).toBeNull();\n    });\n  });\n\n  describe(\"Transcription\", () => {\n    it(\"should trigger transcription after recording stops with blob URL\", async () => {\n      mockTranscribe.mockResolvedValue(\"Hello world\");\n\n      setupMediaRecorderMock({\n        status: \"stopped\",\n        mediaBlobUrl: \"blob:http://localhost/audio\",\n      });\n\n      const { result } = renderHook(() => useTamboVoice(), {\n        wrapper: createWrapper(),\n      });\n\n      await waitFor(() => {\n        expect(result.current.transcript).toBe(\"Hello world\");\n      });\n\n      expect(mockFetch).toHaveBeenCalledWith(\"blob:http://localhost/audio\");\n      expect(mockTranscribe).toHaveBeenCalled();\n    });\n\n    it(\"should expose isTranscribing=true during API call\", async () => {\n      let resolveTranscription: (value: string) => void;\n      mockTranscribe.mockImplementation(\n        async () =>\n          await new Promise((resolve) => {\n            resolveTranscription = resolve;\n          }),\n      );\n\n      setupMediaRecorderMock({\n        status: \"stopped\",\n        mediaBlobUrl: \"blob:http://localhost/audio\",\n      });\n\n      const { result } = renderHook(() => useTamboVoice(), {\n        wrapper: createWrapper(),\n      });\n\n      await waitFor(() => {\n        expect(result.current.isTranscribing).toBe(true);\n      });\n\n      // Complete the transcription\n      act(() => {\n        resolveTranscription!(\"transcribed text\");\n      });\n\n      await waitFor(() => {\n        expect(result.current.isTranscribing).toBe(false);\n      });\n    });\n  });\n\n  describe(\"Error Handling\", () => {\n    it(\"should expose mediaAccessError when microphone access fails\", () => {\n      setupMediaRecorderMock({\n        error: \"Permission denied\",\n      });\n\n      const { result } = renderHook(() => useTamboVoice(), {\n        wrapper: createWrapper(),\n      });\n\n      expect(result.current.mediaAccessError).toBe(\"Permission denied\");\n    });\n\n    it(\"should expose transcriptionError when API call fails\", async () => {\n      mockTranscribe.mockRejectedValue(\n        new Error(\"Transcription service unavailable\"),\n      );\n\n      setupMediaRecorderMock({\n        status: \"stopped\",\n        mediaBlobUrl: \"blob:http://localhost/audio\",\n      });\n\n      const { result } = renderHook(() => useTamboVoice(), {\n        wrapper: createWrapper(),\n      });\n\n      await waitFor(() => {\n        expect(result.current.transcriptionError).toBe(\n          \"Transcription service unavailable\",\n        );\n      });\n\n      expect(result.current.isTranscribing).toBe(false);\n    });\n\n    it(\"should handle blob fetch failure gracefully\", async () => {\n      mockFetch.mockRejectedValue(new Error(\"Network error\"));\n\n      setupMediaRecorderMock({\n        status: \"stopped\",\n        mediaBlobUrl: \"blob:http://localhost/audio\",\n      });\n\n      const { result } = renderHook(() => useTamboVoice(), {\n        wrapper: createWrapper(),\n      });\n\n      await waitFor(() => {\n        expect(result.current.transcriptionError).toBe(\"Network error\");\n      });\n\n      expect(result.current.isTranscribing).toBe(false);\n      expect(result.current.transcript).toBeNull();\n    });\n  });\n});\n"]}
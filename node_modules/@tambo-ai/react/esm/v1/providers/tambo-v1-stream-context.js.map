{"version":3,"file":"tambo-v1-stream-context.js","sourceRoot":"","sources":["../../../src/v1/providers/tambo-v1-stream-context.tsx"],"names":[],"mappings":"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","sourcesContent":["\"use client\";\n\n/**\n * Stream Context Provider for v1 API\n *\n * Manages streaming state using React Context and useReducer.\n * Provides state and dispatch to child components via separate contexts\n * following the split-context pattern for optimal re-render performance.\n */\n\nimport React, {\n  createContext,\n  useReducer,\n  useContext,\n  useMemo,\n  useCallback,\n} from \"react\";\nimport {\n  streamReducer,\n  type StreamState,\n  type StreamAction,\n} from \"../utils/event-accumulator\";\nimport type { TamboV1Thread } from \"../types/thread\";\n\n/**\n * Thread management functions exposed by the stream context.\n */\nexport interface ThreadManagement {\n  /**\n   * Initialize a new thread in the stream context.\n   * Use this before sending messages to a new thread.\n   * @param threadId - The thread ID to initialize\n   * @param initialThread - Optional initial thread data\n   */\n  initThread: (\n    threadId: string,\n    initialThread?: Partial<TamboV1Thread>,\n  ) => void;\n\n  /**\n   * Switch the current active thread.\n   * Does not fetch thread data - use useTamboV1Thread for that.\n   * @param threadId - The thread ID to switch to, or null to clear\n   */\n  switchThread: (threadId: string | null) => void;\n\n  /**\n   * Start a new thread (generates a temporary ID).\n   * The actual thread ID will be assigned when the first message is sent.\n   * @returns The temporary thread ID\n   */\n  startNewThread: () => string;\n}\n\n/**\n * Context for accessing stream state (read-only).\n * Separated from dispatch context to prevent unnecessary re-renders.\n */\nconst StreamStateContext = createContext<StreamState | null>(null);\n\n/**\n * Context for dispatching events to the stream reducer.\n * Separated from state context to prevent unnecessary re-renders.\n */\nconst StreamDispatchContext =\n  createContext<React.Dispatch<StreamAction> | null>(null);\n\n/**\n * Context for thread management functions.\n * Separated from state to prevent unnecessary re-renders.\n */\nconst ThreadManagementContext = createContext<ThreadManagement | null>(null);\n\n/**\n * Props for TamboV1StreamProvider\n */\nexport interface TamboV1StreamProviderProps {\n  children: React.ReactNode;\n\n  /**\n   * Optional override for stream state (primarily for tests).\n   * If provided, you must also provide `dispatch`.\n   */\n  state?: StreamState;\n\n  /**\n   * Optional override for stream dispatch (primarily for tests).\n   * If provided, you must also provide `state`.\n   */\n  dispatch?: React.Dispatch<StreamAction>;\n\n  /**\n   * Optional override for thread management functions (primarily for tests).\n   */\n  threadManagement?: ThreadManagement;\n}\n\n/**\n * Provider component for stream state management.\n *\n * Uses useReducer with streamReducer to accumulate AG-UI events into\n * thread state. Provides state, dispatch, and thread management via separate contexts.\n *\n * Thread management is done programmatically via the hooks:\n * - startNewThread() - Start a new conversation\n * - switchThread(threadId) - Switch to an existing thread\n * - initThread(threadId) - Initialize a thread for receiving events\n * @returns JSX element wrapping children with stream contexts\n * @example\n * ```tsx\n * <TamboV1StreamProvider>\n *   <ChatInterface />\n * </TamboV1StreamProvider>\n * ```\n */\nexport function TamboV1StreamProvider(props: TamboV1StreamProviderProps) {\n  const { children, state: providedState, dispatch: providedDispatch } = props;\n\n  if (\n    (providedState && !providedDispatch) ||\n    (!providedState && providedDispatch)\n  ) {\n    throw new Error(\n      \"TamboV1StreamProvider requires both state and dispatch when overriding\",\n    );\n  }\n\n  if (props.threadManagement) {\n    const { initThread, switchThread, startNewThread } = props.threadManagement;\n    if (\n      typeof initThread !== \"function\" ||\n      typeof switchThread !== \"function\" ||\n      typeof startNewThread !== \"function\"\n    ) {\n      throw new Error(\n        \"TamboV1StreamProvider: threadManagement override is missing required methods\",\n      );\n    }\n  }\n\n  // Create stable initial state - only computed once on mount\n  const [state, dispatch] = useReducer(\n    streamReducer,\n    undefined,\n    // Lazy initializer function\n    () => ({\n      threadMap: {},\n      currentThreadId: null,\n    }),\n  );\n\n  const activeState = providedState ?? state;\n  const activeDispatch = providedDispatch ?? dispatch;\n\n  // Thread management functions\n  const initThread = useCallback(\n    (threadId: string, initialThread?: Partial<TamboV1Thread>) => {\n      activeDispatch({ type: \"INIT_THREAD\", threadId, initialThread });\n    },\n    [activeDispatch],\n  );\n\n  const switchThread = useCallback(\n    (threadId: string | null) => {\n      activeDispatch({ type: \"SET_CURRENT_THREAD\", threadId });\n    },\n    [activeDispatch],\n  );\n\n  const startNewThread = useCallback(() => {\n    const tempId = `temp_${crypto.randomUUID()}`;\n    // Use atomic START_NEW_THREAD action to prevent race conditions\n    // when multiple calls happen concurrently (e.g., double-click)\n    activeDispatch({ type: \"START_NEW_THREAD\", threadId: tempId });\n    return tempId;\n  }, [activeDispatch]);\n\n  const threadManagement = useMemo<ThreadManagement>(() => {\n    return (\n      props.threadManagement ?? {\n        initThread,\n        switchThread,\n        startNewThread,\n      }\n    );\n  }, [props.threadManagement, initThread, switchThread, startNewThread]);\n\n  return (\n    <StreamStateContext.Provider value={activeState}>\n      <StreamDispatchContext.Provider value={activeDispatch}>\n        <ThreadManagementContext.Provider value={threadManagement}>\n          {children}\n        </ThreadManagementContext.Provider>\n      </StreamDispatchContext.Provider>\n    </StreamStateContext.Provider>\n  );\n}\n\n/**\n * Hook to access stream state.\n *\n * Must be used within TamboV1StreamProvider.\n * @returns Current stream state\n * @throws {Error} if used outside TamboV1StreamProvider\n * @example\n * ```tsx\n * function ChatMessages() {\n *   const { thread, streaming } = useStreamState();\n *\n *   return (\n *     <div>\n *       {thread.messages.map(msg => <Message key={msg.id} message={msg} />)}\n *       {streaming.status === 'streaming' && <LoadingIndicator />}\n *     </div>\n *   );\n * }\n * ```\n */\nexport function useStreamState(): StreamState {\n  const context = useContext(StreamStateContext);\n\n  if (!context) {\n    throw new Error(\"useStreamState must be used within TamboV1StreamProvider\");\n  }\n\n  return context;\n}\n\n/**\n * Hook to access stream dispatch function.\n *\n * Must be used within TamboV1StreamProvider.\n * @returns Dispatch function for sending events to reducer\n * @throws {Error} if used outside TamboV1StreamProvider\n * @example\n * ```tsx\n * function StreamHandler() {\n *   const dispatch = useStreamDispatch();\n *\n *   useEffect(() => {\n *     async function handleStream() {\n *       for await (const event of streamEvents) {\n *         dispatch({ type: 'EVENT', event });\n *       }\n *     }\n *     handleStream();\n *   }, [dispatch]);\n *\n *   return null;\n * }\n * ```\n */\nexport function useStreamDispatch(): React.Dispatch<StreamAction> {\n  const context = useContext(StreamDispatchContext);\n\n  if (!context) {\n    throw new Error(\n      \"useStreamDispatch must be used within TamboV1StreamProvider\",\n    );\n  }\n\n  return context;\n}\n\n/**\n * Hook to access thread management functions.\n *\n * Must be used within TamboV1StreamProvider.\n * @returns Thread management functions\n * @throws {Error} if used outside TamboV1StreamProvider\n * @example\n * ```tsx\n * function ThreadSwitcher() {\n *   const { switchThread, startNewThread } = useThreadManagement();\n *\n *   return (\n *     <div>\n *       <button onClick={() => switchThread('thread_123')}>\n *         Load Thread\n *       </button>\n *       <button onClick={startNewThread}>\n *         New Chat\n *       </button>\n *     </div>\n *   );\n * }\n * ```\n */\nexport function useThreadManagement(): ThreadManagement {\n  const context = useContext(ThreadManagementContext);\n\n  if (!context) {\n    throw new Error(\n      \"useThreadManagement must be used within TamboV1StreamProvider\",\n    );\n  }\n\n  return context;\n}\n"]}
{"version":3,"file":"tool-call-tracker.js","sourceRoot":"","sources":["../../../src/v1/utils/tool-call-tracker.ts"],"names":[],"mappings":"AAAA;;;;;GAKG;AAEH,OAAO,EAAE,SAAS,EAAkB,MAAM,aAAa,CAAC;AAGxD;;;;;;;;;;GAUG;AACH,MAAM,OAAO,eAAe;IAClB,gBAAgB,GAAG,IAAI,GAAG,EAA2B,CAAC;IACtD,gBAAgB,GAAG,IAAI,GAAG,EAAkB,CAAC;IAErD;;;;OAIG;IACH,WAAW,CAAC,KAAgB;QAC1B,QAAQ,KAAK,CAAC,IAAI,EAAE,CAAC;YACnB,KAAK,SAAS,CAAC,eAAe;gBAC5B,IAAI,CAAC,gBAAgB,CAAC,GAAG,CAAC,KAAK,CAAC,UAAU,EAAE;oBAC1C,IAAI,EAAE,KAAK,CAAC,YAAY;oBACxB,KAAK,EAAE,EAAE;iBACV,CAAC,CAAC;gBACH,IAAI,CAAC,gBAAgB,CAAC,GAAG,CAAC,KAAK,CAAC,UAAU,EAAE,EAAE,CAAC,CAAC;gBAChD,MAAM;YAER,KAAK,SAAS,CAAC,cAAc,CAAC,CAAC,CAAC;gBAC9B,MAAM,OAAO,GAAG,IAAI,CAAC,gBAAgB,CAAC,GAAG,CAAC,KAAK,CAAC,UAAU,CAAC,CAAC;gBAC5D,IAAI,CAAC,gBAAgB,CAAC,GAAG,CACvB,KAAK,CAAC,UAAU,EAChB,CAAC,OAAO,IAAI,EAAE,CAAC,GAAG,KAAK,CAAC,KAAK,CAC9B,CAAC;gBACF,MAAM;YACR,CAAC;YAED,KAAK,SAAS,CAAC,aAAa,CAAC,CAAC,CAAC;gBAC7B,MAAM,OAAO,GAAG,IAAI,CAAC,gBAAgB,CAAC,GAAG,CAAC,KAAK,CAAC,UAAU,CAAC,CAAC;gBAC5D,MAAM,QAAQ,GAAG,IAAI,CAAC,gBAAgB,CAAC,GAAG,CAAC,KAAK,CAAC,UAAU,CAAC,CAAC;gBAC7D,IAAI,QAAQ,IAAI,OAAO,EAAE,CAAC;oBACxB,IAAI,CAAC;wBACH,QAAQ,CAAC,KAAK,GAAG,IAAI,CAAC,KAAK,CAAC,OAAO,CAA4B,CAAC;oBAClE,CAAC;oBAAC,OAAO,KAAK,EAAE,CAAC;wBACf,sDAAsD;wBACtD,MAAM,IAAI,KAAK,CACb,2CAA2C,KAAK,CAAC,UAAU,KAAK,KAAK,YAAY,KAAK,CAAC,CAAC,CAAC,KAAK,CAAC,OAAO,CAAC,CAAC,CAAC,eAAe,WAAW,OAAO,CAAC,KAAK,CAAC,CAAC,EAAE,GAAG,CAAC,GAAG,OAAO,CAAC,MAAM,GAAG,GAAG,CAAC,CAAC,CAAC,KAAK,CAAC,CAAC,CAAC,EAAE,EAAE,CAC/L,CAAC;oBACJ,CAAC;gBACH,CAAC;gBACD,MAAM;YACR,CAAC;YAED;gBACE,oEAAoE;gBACpE,MAAM;QACV,CAAC;IACH,CAAC;IAED;;;;OAIG;IACH,gBAAgB,CAAC,WAAqB;QACpC,MAAM,MAAM,GAAG,IAAI,GAAG,EAA2B,CAAC;QAClD,KAAK,MAAM,EAAE,IAAI,WAAW,EAAE,CAAC;YAC7B,MAAM,QAAQ,GAAG,IAAI,CAAC,gBAAgB,CAAC,GAAG,CAAC,EAAE,CAAC,CAAC;YAC/C,IAAI,QAAQ,EAAE,CAAC;gBACb,MAAM,CAAC,GAAG,CAAC,EAAE,EAAE,QAAQ,CAAC,CAAC;YAC3B,CAAC;QACH,CAAC;QACD,OAAO,MAAM,CAAC;IAChB,CAAC;IAED;;;OAGG;IACH,cAAc,CAAC,WAAqB;QAClC,KAAK,MAAM,EAAE,IAAI,WAAW,EAAE,CAAC;YAC7B,IAAI,CAAC,gBAAgB,CAAC,MAAM,CAAC,EAAE,CAAC,CAAC;YACjC,IAAI,CAAC,gBAAgB,CAAC,MAAM,CAAC,EAAE,CAAC,CAAC;QACnC,CAAC;IACH,CAAC;CACF","sourcesContent":["/**\n * Tool Call Tracker for v1 API\n *\n * Tracks tool calls during streaming, accumulating arguments until complete.\n * Used by the send message hook to collect tool call state for execution.\n */\n\nimport { EventType, type AGUIEvent } from \"@ag-ui/core\";\nimport type { PendingToolCall } from \"./tool-executor\";\n\n/**\n * Tracks tool calls during streaming, accumulating arguments until complete.\n *\n * Tool calls arrive as a sequence of events:\n * 1. TOOL_CALL_START - initializes the tool call with name\n * 2. TOOL_CALL_ARGS (multiple) - streams JSON argument fragments\n * 3. TOOL_CALL_END - marks the tool call as complete, triggers JSON parsing\n *\n * This class accumulates these events and provides the complete tool call\n * data when requested for execution.\n */\nexport class ToolCallTracker {\n  private pendingToolCalls = new Map<string, PendingToolCall>();\n  private accumulatingArgs = new Map<string, string>();\n\n  /**\n   * Handles a streaming event, tracking tool call state as needed.\n   * @param event - The streaming event to process\n   * @throws {Error} If JSON parsing fails on TOOL_CALL_END (fail-fast, no silent fallback)\n   */\n  handleEvent(event: AGUIEvent): void {\n    switch (event.type) {\n      case EventType.TOOL_CALL_START:\n        this.pendingToolCalls.set(event.toolCallId, {\n          name: event.toolCallName,\n          input: {},\n        });\n        this.accumulatingArgs.set(event.toolCallId, \"\");\n        break;\n\n      case EventType.TOOL_CALL_ARGS: {\n        const current = this.accumulatingArgs.get(event.toolCallId);\n        this.accumulatingArgs.set(\n          event.toolCallId,\n          (current ?? \"\") + event.delta,\n        );\n        break;\n      }\n\n      case EventType.TOOL_CALL_END: {\n        const jsonStr = this.accumulatingArgs.get(event.toolCallId);\n        const toolCall = this.pendingToolCalls.get(event.toolCallId);\n        if (toolCall && jsonStr) {\n          try {\n            toolCall.input = JSON.parse(jsonStr) as Record<string, unknown>;\n          } catch (error) {\n            // Fail-fast: don't silently continue with empty input\n            throw new Error(\n              `Failed to parse tool call arguments for ${event.toolCallId}: ${error instanceof Error ? error.message : \"Unknown error\"}. JSON: ${jsonStr.slice(0, 100)}${jsonStr.length > 100 ? \"...\" : \"\"}`,\n            );\n          }\n        }\n        break;\n      }\n\n      default:\n        // Other event types are ignored - only tool call events are tracked\n        break;\n    }\n  }\n\n  /**\n   * Gets tool calls for the given IDs, filtered to only those that exist.\n   * @param toolCallIds - IDs of tool calls to retrieve\n   * @returns Map of tool call ID to pending tool call\n   */\n  getToolCallsById(toolCallIds: string[]): Map<string, PendingToolCall> {\n    const result = new Map<string, PendingToolCall>();\n    for (const id of toolCallIds) {\n      const toolCall = this.pendingToolCalls.get(id);\n      if (toolCall) {\n        result.set(id, toolCall);\n      }\n    }\n    return result;\n  }\n\n  /**\n   * Clears tracked tool calls for the given IDs.\n   * @param toolCallIds - IDs of tool calls to clear\n   */\n  clearToolCalls(toolCallIds: string[]): void {\n    for (const id of toolCallIds) {\n      this.pendingToolCalls.delete(id);\n      this.accumulatingArgs.delete(id);\n    }\n  }\n}\n"]}
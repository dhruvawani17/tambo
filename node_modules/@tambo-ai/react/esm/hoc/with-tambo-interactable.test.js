import { render, screen, waitFor } from "@testing-library/react";
import React from "react";
import { z } from "zod/v3";
import { useTamboCurrentComponent } from "../hooks/use-current-message";
import { TamboInteractableProvider } from "../providers/tambo-interactable-provider";
import { withTamboInteractable } from "./with-tambo-interactable";
// Create a consistent mock implementation
const mockAddInteractableComponent = jest.fn(() => "mock-id-123");
const mockUpdateInteractableComponentProps = jest.fn();
const mockGetInteractableComponent = jest.fn(() => null);
const mockRemoveInteractableComponent = jest.fn();
const mockGetInteractableComponentsByName = jest.fn(() => []);
const mockClearAllInteractableComponents = jest.fn();
// Mock the interactable provider
jest.mock("../providers/tambo-interactable-provider", () => ({
    TamboInteractableProvider: ({ children }) => (React.createElement("div", { "data-testid": "interactable-provider" }, children)),
    useTamboInteractable: () => ({
        addInteractableComponent: mockAddInteractableComponent,
        updateInteractableComponentProps: mockUpdateInteractableComponentProps,
        getInteractableComponent: mockGetInteractableComponent,
        removeInteractableComponent: mockRemoveInteractableComponent,
        getInteractableComponentsByName: mockGetInteractableComponentsByName,
        clearAllInteractableComponents: mockClearAllInteractableComponents,
        interactableComponents: [],
    }),
}));
describe("withTamboInteractable", () => {
    const TestComponent = ({ title, count }) => (React.createElement("div", null,
        React.createElement("h1", { "data-testid": "title" }, title),
        count !== undefined && React.createElement("span", { "data-testid": "count" }, count)));
    const testSchema = z.object({
        title: z.string(),
        count: z.number().optional(),
    });
    beforeEach(() => {
        jest.clearAllMocks();
        // Reset mock implementations
        mockAddInteractableComponent.mockReturnValue("mock-id-123");
        mockGetInteractableComponent.mockReturnValue(null);
        mockGetInteractableComponentsByName.mockReturnValue([]);
    });
    it("should render the wrapped component with provided props", () => {
        const InteractableComponent = withTamboInteractable(TestComponent, {
            componentName: "TestComponent",
            description: "A test component",
            propsSchema: testSchema,
        });
        render(React.createElement(TamboInteractableProvider, null,
            React.createElement(InteractableComponent, { title: "Hello", count: 42 })));
        expect(screen.getByTestId("title")).toHaveTextContent("Hello");
        expect(screen.getByTestId("count")).toHaveTextContent("42");
    });
    it("should set displayName correctly", () => {
        const InteractableComponent = withTamboInteractable(TestComponent, {
            componentName: "TestComponent",
            description: "A test component",
        });
        expect(InteractableComponent.displayName).toBe("withTamboInteractable(TestComponent)");
    });
    it("should handle components without displayName", () => {
        const AnonymousComponent = () => React.createElement("div", null, "Anonymous");
        const InteractableComponent = withTamboInteractable(AnonymousComponent, {
            componentName: "AnonymousComponent",
            description: "An anonymous component",
        });
        // Anonymous components get their name from the function name
        expect(InteractableComponent.displayName).toBe("withTamboInteractable(AnonymousComponent)");
    });
    it("should provide TamboMessageProvider with interactable metadata", async () => {
        // Child component that uses the context
        const ContextConsumer = () => {
            const component = useTamboCurrentComponent();
            return (React.createElement("div", null,
                React.createElement("span", { "data-testid": "interactable-id" }, component?.interactableId),
                React.createElement("span", { "data-testid": "component-name" }, component?.componentName),
                React.createElement("span", { "data-testid": "description" }, component?.description)));
        };
        // Wrap TestComponent to include ContextConsumer
        const TestComponentWithConsumer = (props) => (React.createElement("div", null,
            React.createElement(TestComponent, { ...props }),
            React.createElement(ContextConsumer, null)));
        const InteractableWithConsumer = withTamboInteractable(TestComponentWithConsumer, {
            componentName: "TestComponent",
            description: "A test component",
            propsSchema: testSchema,
        });
        render(React.createElement(TamboInteractableProvider, null,
            React.createElement(InteractableWithConsumer, { title: "Hello" })));
        // Wait for the component to register and render
        await waitFor(() => {
            expect(screen.getByTestId("interactable-id")).toHaveTextContent("mock-id-123");
        });
        expect(screen.getByTestId("component-name")).toHaveTextContent("TestComponent");
        expect(screen.getByTestId("description")).toHaveTextContent("A test component");
    });
    it("should create minimal message with correct structure", async () => {
        // Child component that checks the message structure
        const MessageChecker = () => {
            const component = useTamboCurrentComponent();
            return (React.createElement("div", null,
                React.createElement("span", { "data-testid": "has-component-name" }, component?.componentName ? "yes" : "no"),
                React.createElement("span", { "data-testid": "has-props" }, component?.props ? "yes" : "no"),
                React.createElement("span", { "data-testid": "has-interactable-id" }, component?.interactableId ? "yes" : "no"),
                React.createElement("span", { "data-testid": "has-description" }, component?.description ? "yes" : "no")));
        };
        const TestComponentWithChecker = (props) => (React.createElement("div", null,
            React.createElement(TestComponent, { ...props }),
            React.createElement(MessageChecker, null)));
        const InteractableWithChecker = withTamboInteractable(TestComponentWithChecker, {
            componentName: "TestComponent",
            description: "A test component",
            propsSchema: testSchema,
        });
        render(React.createElement(TamboInteractableProvider, null,
            React.createElement(InteractableWithChecker, { title: "Hello", count: 42 })));
        await waitFor(() => {
            expect(screen.getByTestId("has-component-name")).toHaveTextContent("yes");
        });
        expect(screen.getByTestId("has-props")).toHaveTextContent("yes");
        expect(screen.getByTestId("has-interactable-id")).toHaveTextContent("yes");
        expect(screen.getByTestId("has-description")).toHaveTextContent("yes");
    });
    it("should pass through all component props correctly", () => {
        const InteractableComponent = withTamboInteractable(TestComponent, {
            componentName: "TestComponent",
            description: "A test component",
            propsSchema: testSchema,
        });
        render(React.createElement(TamboInteractableProvider, null,
            React.createElement(InteractableComponent, { title: "Test Title", count: 100 })));
        expect(screen.getByTestId("title")).toHaveTextContent("Test Title");
        expect(screen.getByTestId("count")).toHaveTextContent("100");
    });
    it("should filter out interactable-specific props from component props", () => {
        const ExtendedComponent = ({ title, onInteractableReady, onPropsUpdate, }) => (React.createElement("div", null,
            React.createElement("span", { "data-testid": "title" }, title),
            React.createElement("span", { "data-testid": "has-ready" }, onInteractableReady ? "yes" : "no"),
            React.createElement("span", { "data-testid": "has-update" }, onPropsUpdate ? "yes" : "no")));
        const InteractableComponent = withTamboInteractable(ExtendedComponent, {
            componentName: "ExtendedComponent",
            description: "An extended component",
        });
        const mockReady = jest.fn();
        const mockUpdate = jest.fn();
        render(React.createElement(TamboInteractableProvider, null,
            React.createElement(InteractableComponent, { title: "Test", onInteractableReady: mockReady, onPropsUpdate: mockUpdate })));
        expect(screen.getByTestId("title")).toHaveTextContent("Test");
        // These props should be filtered out
        expect(screen.getByTestId("has-ready")).toHaveTextContent("no");
        expect(screen.getByTestId("has-update")).toHaveTextContent("no");
    });
    it("should work without propsSchema", () => {
        const InteractableComponent = withTamboInteractable(TestComponent, {
            componentName: "TestComponent",
            description: "A test component",
        });
        render(React.createElement(TamboInteractableProvider, null,
            React.createElement(InteractableComponent, { title: "No Schema" })));
        expect(screen.getByTestId("title")).toHaveTextContent("No Schema");
    });
    it("should render before interactable ID is set", () => {
        const InteractableComponent = withTamboInteractable(TestComponent, {
            componentName: "TestComponent",
            description: "A test component",
        });
        const { container } = render(React.createElement(TamboInteractableProvider, null,
            React.createElement(InteractableComponent, { title: "Early Render" })));
        // Component should render even before ID is available
        expect(container.querySelector('[data-testid="title"]')).toBeInTheDocument();
    });
    it("should handle null/undefined values in props", () => {
        const NullableComponent = ({ title, optional, nullable, }) => (React.createElement("div", null,
            React.createElement("span", { "data-testid": "title" }, title),
            React.createElement("span", { "data-testid": "optional" }, optional ?? "undefined"),
            React.createElement("span", { "data-testid": "nullable" }, nullable ?? "null")));
        const InteractableComponent = withTamboInteractable(NullableComponent, {
            componentName: "NullableComponent",
            description: "A component with nullable props",
        });
        render(React.createElement(TamboInteractableProvider, null,
            React.createElement(InteractableComponent, { title: "Test", nullable: null })));
        expect(screen.getByTestId("title")).toHaveTextContent("Test");
        expect(screen.getByTestId("optional")).toHaveTextContent("undefined");
        expect(screen.getByTestId("nullable")).toHaveTextContent("null");
    });
});
//# sourceMappingURL=with-tambo-interactable.test.js.map
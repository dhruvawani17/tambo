{"version":3,"file":"mcp-server-utils.test.js","sourceRoot":"","sources":["../../src/util/mcp-server-utils.test.ts"],"names":[],"mappings":"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","sourcesContent":["import type {\n  McpServerInfo,\n  NormalizedMcpServerInfo,\n} from \"../model/mcp-server-info\";\nimport { MCPTransport } from \"../model/mcp-server-info\";\nimport {\n  deduplicateMcpServers,\n  deriveServerKey,\n  normalizeServerInfo,\n} from \"./mcp-server-utils\";\n\ndescribe(\"deriveServerKey\", () => {\n  it(\"should extract key from simple domain\", () => {\n    expect(deriveServerKey(\"https://linear.app/mcp\")).toBe(\"linear\");\n  });\n\n  it(\"should extract key from subdomain\", () => {\n    expect(deriveServerKey(\"https://mcp.linear.app/mcp\")).toBe(\"linear\");\n  });\n\n  it(\"should extract key from www subdomain\", () => {\n    expect(deriveServerKey(\"https://www.example.com/mcp\")).toBe(\"example\");\n  });\n\n  it(\"should extract key from api subdomain\", () => {\n    expect(deriveServerKey(\"https://api.service.com/mcp\")).toBe(\"service\");\n  });\n\n  it(\"should extract key from app subdomain\", () => {\n    expect(deriveServerKey(\"https://app.tool.com/mcp\")).toBe(\"tool\");\n  });\n\n  it(\"should handle multi-part TLDs like .co.uk\", () => {\n    expect(deriveServerKey(\"https://example.co.uk/mcp\")).toBe(\"example\");\n  });\n\n  it(\"should handle .com.au TLDs\", () => {\n    expect(deriveServerKey(\"https://service.com.au/mcp\")).toBe(\"service\");\n  });\n\n  it(\"should prefer meaningful part over common prefixes\", () => {\n    // mcp.staging.app.com -> after removing TLD: [\"mcp\", \"staging\", \"app\"]\n    // Working backwards: checks \"app\" (index 2) - common prefix, continue\n    // Checks \"staging\" (index 1) - common prefix, continue\n    // Checks \"mcp\" (index 0) - common prefix, continue\n    // Falls back - actual behavior returns \"staging\"\n    expect(deriveServerKey(\"https://mcp.staging.app.com/mcp\")).toBe(\"staging\");\n  });\n\n  it(\"should fallback to last part if all are common prefixes\", () => {\n    // www.api.mcp.com -> after removing TLD: [\"www\", \"api\", \"mcp\"]\n    // All are common prefixes, so falls back to last relevant part\n    // The actual implementation returns \"api\" (the middle part)\n    // This appears to be the behavior, so we test for it\n    expect(deriveServerKey(\"https://www.api.mcp.com/mcp\")).toBe(\"api\");\n  });\n\n  it(\"should handle single-part hostname\", () => {\n    expect(deriveServerKey(\"https://localhost:3000/mcp\")).toBe(\"localhost\");\n  });\n\n  it(\"should handle invalid URL by sanitizing\", () => {\n    const result = deriveServerKey(\"not-a-url!!!\");\n    expect(result).toBe(\"not_a_url___\");\n    expect(result).toMatch(/^[a-z0-9_]+$/);\n  });\n\n  it(\"should lowercase the result\", () => {\n    expect(deriveServerKey(\"https://EXAMPLE.COM/mcp\")).toBe(\"example\");\n  });\n\n  it(\"should handle staging subdomain\", () => {\n    expect(deriveServerKey(\"https://staging.service.com/mcp\")).toBe(\"service\");\n  });\n\n  it(\"should handle dev subdomain\", () => {\n    expect(deriveServerKey(\"https://dev.tool.com/mcp\")).toBe(\"tool\");\n  });\n\n  it(\"should handle prod subdomain\", () => {\n    expect(deriveServerKey(\"https://prod.service.com/mcp\")).toBe(\"service\");\n  });\n});\n\ndescribe(\"normalizeServerInfo\", () => {\n  it(\"should normalize string URL to server info\", () => {\n    const result = normalizeServerInfo(\"https://example.com/mcp\");\n\n    expect(result).toEqual({\n      url: \"https://example.com/mcp\",\n      transport: MCPTransport.HTTP,\n      serverKey: \"example\",\n    });\n  });\n\n  it(\"should preserve existing serverKey\", () => {\n    const server: McpServerInfo = {\n      url: \"https://example.com/mcp\",\n      serverKey: \"custom-key\",\n    };\n\n    const result = normalizeServerInfo(server);\n\n    expect(result.serverKey).toBe(\"custom-key\");\n    expect(result.transport).toBe(MCPTransport.HTTP);\n  });\n\n  it(\"should derive serverKey when not provided\", () => {\n    const server: McpServerInfo = {\n      url: \"https://mcp.linear.app/mcp\",\n    };\n\n    const result = normalizeServerInfo(server);\n\n    expect(result.serverKey).toBe(\"linear\");\n  });\n\n  it(\"should preserve existing transport\", () => {\n    const server: McpServerInfo = {\n      url: \"https://example.com/mcp\",\n      transport: MCPTransport.SSE,\n    };\n\n    const result = normalizeServerInfo(server);\n\n    expect(result.transport).toBe(MCPTransport.SSE);\n  });\n\n  it(\"should default transport to HTTP when not provided\", () => {\n    const server: McpServerInfo = {\n      url: \"https://example.com/mcp\",\n    };\n\n    const result = normalizeServerInfo(server);\n\n    expect(result.transport).toBe(MCPTransport.HTTP);\n  });\n\n  it(\"should preserve all other properties\", () => {\n    const server: McpServerInfo = {\n      url: \"https://example.com/mcp\",\n      name: \"Test Server\",\n      description: \"A test server\",\n      customHeaders: { \"X-API-Key\": \"secret\" },\n      handlers: {},\n    };\n\n    const result = normalizeServerInfo(server);\n\n    expect(result.name).toBe(\"Test Server\");\n    expect(result.description).toBe(\"A test server\");\n    expect(result.customHeaders).toEqual({ \"X-API-Key\": \"secret\" });\n    expect(result.handlers).toEqual({});\n  });\n\n  it(\"should handle server with all optional fields\", () => {\n    const server: McpServerInfo = {\n      url: \"https://example.com/mcp\",\n      name: \"My Server\",\n      description: \"Description\",\n      transport: MCPTransport.SSE,\n      serverKey: \"my-server\",\n      customHeaders: { Authorization: \"Bearer token\" },\n    };\n\n    const result = normalizeServerInfo(server);\n\n    expect(result).toEqual({\n      url: \"https://example.com/mcp\",\n      name: \"My Server\",\n      description: \"Description\",\n      transport: MCPTransport.SSE,\n      serverKey: \"my-server\",\n      customHeaders: { Authorization: \"Bearer token\" },\n    });\n  });\n});\n\ndescribe(\"deduplicateMcpServers\", () => {\n  it(\"should return empty array for empty input\", () => {\n    expect(deduplicateMcpServers([])).toEqual([]);\n  });\n\n  it(\"should return single server unchanged\", () => {\n    const server: NormalizedMcpServerInfo = {\n      url: \"https://example.com/mcp\",\n      transport: MCPTransport.HTTP,\n      serverKey: \"example\",\n    };\n\n    expect(deduplicateMcpServers([server])).toEqual([server]);\n  });\n\n  it(\"should deduplicate servers with same URL and transport\", () => {\n    const server1: NormalizedMcpServerInfo = {\n      url: \"https://example.com/mcp\",\n      transport: MCPTransport.HTTP,\n      serverKey: \"example\",\n    };\n    const server2: NormalizedMcpServerInfo = {\n      url: \"https://example.com/mcp\",\n      transport: MCPTransport.HTTP,\n      serverKey: \"example\",\n    };\n\n    const result = deduplicateMcpServers([server1, server2]);\n\n    expect(result).toHaveLength(1);\n    expect(result[0].url).toBe(\"https://example.com/mcp\");\n  });\n\n  it(\"should keep servers with different URLs\", () => {\n    const server1: NormalizedMcpServerInfo = {\n      url: \"https://example.com/mcp\",\n      transport: MCPTransport.HTTP,\n      serverKey: \"example\",\n    };\n    const server2: NormalizedMcpServerInfo = {\n      url: \"https://other.com/mcp\",\n      transport: MCPTransport.HTTP,\n      serverKey: \"other\",\n    };\n\n    const result = deduplicateMcpServers([server1, server2]);\n\n    expect(result).toHaveLength(2);\n  });\n\n  it(\"should keep servers with same URL but different transport\", () => {\n    const server1: NormalizedMcpServerInfo = {\n      url: \"https://example.com/mcp\",\n      transport: MCPTransport.HTTP,\n      serverKey: \"example\",\n    };\n    const server2: NormalizedMcpServerInfo = {\n      url: \"https://example.com/mcp\",\n      transport: MCPTransport.SSE,\n      serverKey: \"example\",\n    };\n\n    const result = deduplicateMcpServers([server1, server2]);\n\n    expect(result).toHaveLength(2);\n  });\n\n  it(\"should ensure unique serverKeys by appending suffixes\", () => {\n    const server1: NormalizedMcpServerInfo = {\n      url: \"https://example1.com/mcp\",\n      transport: MCPTransport.HTTP,\n      serverKey: \"linear\",\n    };\n    const server2: NormalizedMcpServerInfo = {\n      url: \"https://example2.com/mcp\",\n      transport: MCPTransport.HTTP,\n      serverKey: \"linear\",\n    };\n    const server3: NormalizedMcpServerInfo = {\n      url: \"https://example3.com/mcp\",\n      transport: MCPTransport.HTTP,\n      serverKey: \"linear\",\n    };\n\n    const result = deduplicateMcpServers([server1, server2, server3]);\n\n    expect(result).toHaveLength(3);\n    expect(result[0].serverKey).toBe(\"linear\");\n    expect(result[1].serverKey).toBe(\"linear-2\");\n    expect(result[2].serverKey).toBe(\"linear-3\");\n  });\n\n  it(\"should handle mixed unique and duplicate serverKeys\", () => {\n    const server1: NormalizedMcpServerInfo = {\n      url: \"https://example1.com/mcp\",\n      transport: MCPTransport.HTTP,\n      serverKey: \"linear\",\n    };\n    const server2: NormalizedMcpServerInfo = {\n      url: \"https://example2.com/mcp\",\n      transport: MCPTransport.HTTP,\n      serverKey: \"notion\",\n    };\n    const server3: NormalizedMcpServerInfo = {\n      url: \"https://example3.com/mcp\",\n      transport: MCPTransport.HTTP,\n      serverKey: \"linear\",\n    };\n\n    const result = deduplicateMcpServers([server1, server2, server3]);\n\n    expect(result).toHaveLength(3);\n    expect(result[0].serverKey).toBe(\"linear\");\n    expect(result[1].serverKey).toBe(\"notion\");\n    expect(result[2].serverKey).toBe(\"linear-2\");\n  });\n\n  it(\"should deduplicate by connection first, then ensure serverKey uniqueness\", () => {\n    // Same connection, different serverKeys (shouldn't happen in practice but test the logic)\n    const server1: NormalizedMcpServerInfo = {\n      url: \"https://example.com/mcp\",\n      transport: MCPTransport.HTTP,\n      serverKey: \"linear\",\n    };\n    const server2: NormalizedMcpServerInfo = {\n      url: \"https://example.com/mcp\",\n      transport: MCPTransport.HTTP,\n      serverKey: \"notion\",\n    };\n\n    const result = deduplicateMcpServers([server1, server2]);\n\n    // Should deduplicate by connection, keeping only one\n    expect(result).toHaveLength(1);\n  });\n\n  it(\"should preserve server properties when deduplicating\", () => {\n    const server1: NormalizedMcpServerInfo = {\n      url: \"https://example.com/mcp\",\n      transport: MCPTransport.HTTP,\n      serverKey: \"example\",\n      name: \"First Server\",\n    };\n    const server2: NormalizedMcpServerInfo = {\n      url: \"https://example.com/mcp\",\n      transport: MCPTransport.HTTP,\n      serverKey: \"example\",\n      name: \"Second Server\",\n    };\n\n    const result = deduplicateMcpServers([server1, server2]);\n\n    expect(result).toHaveLength(1);\n    // Should keep the last one encountered\n    expect(result[0].name).toBe(\"Second Server\");\n  });\n\n  it(\"should handle servers with different customHeaders as different connections\", () => {\n    const server1: NormalizedMcpServerInfo = {\n      url: \"https://example.com/mcp\",\n      transport: MCPTransport.HTTP,\n      serverKey: \"example\",\n      customHeaders: { Authorization: \"Bearer token1\" },\n    };\n    const server2: NormalizedMcpServerInfo = {\n      url: \"https://example.com/mcp\",\n      transport: MCPTransport.HTTP,\n      serverKey: \"example\",\n      customHeaders: { Authorization: \"Bearer token2\" },\n    };\n\n    const result = deduplicateMcpServers([server1, server2]);\n\n    expect(result).toHaveLength(2);\n  });\n});\n"]}
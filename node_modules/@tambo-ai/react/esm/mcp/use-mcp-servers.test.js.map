{"version":3,"file":"use-mcp-servers.test.js","sourceRoot":"","sources":["../../src/mcp/use-mcp-servers.test.tsx"],"names":[],"mappings":"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","sourcesContent":["import { render, waitFor } from \"@testing-library/react\";\nimport React, { useEffect } from \"react\";\nimport { TamboMcpTokenProvider } from \"../providers/tambo-mcp-token-provider\";\nimport { TamboRegistryProvider } from \"../providers/tambo-registry-provider\";\nimport { TamboClientContext } from \"../providers/tambo-client-provider\";\nimport { QueryClient } from \"@tanstack/react-query\";\nimport {\n  TamboMcpProvider,\n  useTamboMcpServers,\n  type McpServer,\n} from \"./tambo-mcp-provider\";\n\n// Mock the registry to provide a no-op registerTool\n// Do not mock the registry; use the real provider in render\n\n// Provide a minimal client context instead of mocking the hook\n\n// Mock the MCP client; use a mutable implementation to avoid TDZ issues\nlet createImpl: jest.Mock = jest.fn();\njest.mock(\"./mcp-client\", () => ({\n  MCPClient: { create: (...args: any[]) => createImpl(...args) },\n  MCPTransport: { SSE: \"sse\", HTTP: \"http\" },\n}));\n\n// Import after mocks note: jest.mock calls are hoisted, so standard imports are fine\n\ndescribe(\"useTamboMcpServers + TamboMcpProvider\", () => {\n  beforeEach(() => {\n    createImpl = jest.fn();\n  });\n\n  it(\"provides normalized MCP server entries to inner components\", async () => {\n    const fakeClient = { listTools: jest.fn().mockResolvedValue([]) } as any;\n    createImpl.mockResolvedValue(fakeClient);\n\n    const Inner: React.FC = () => {\n      const servers = useTamboMcpServers();\n      return (\n        <div>\n          <div data-testid=\"count\">{servers.length}</div>\n          <div data-testid=\"urls\">{servers.map((s) => s.url).join(\",\")}</div>\n        </div>\n      );\n    };\n\n    const { getByTestId } = render(\n      <TamboClientContext.Provider\n        value={{\n          client: { baseURL: \"https://api.tambo.co\" } as any,\n          queryClient: new QueryClient(),\n          isUpdatingToken: false,\n        }}\n      >\n        <TamboRegistryProvider\n          mcpServers={[{ url: \"https://one.example\" }, \"https://two.example\"]}\n        >\n          <TamboMcpTokenProvider>\n            <TamboMcpProvider>\n              <Inner />\n            </TamboMcpProvider>\n          </TamboMcpTokenProvider>\n        </TamboRegistryProvider>\n      </TamboClientContext.Provider>,\n    );\n\n    await waitFor(() => {\n      expect(getByTestId(\"count\").textContent).toBe(\"2\");\n      const urls = getByTestId(\"urls\").textContent || \"\";\n      expect(urls).toContain(\"https://one.example\");\n      expect(urls).toContain(\"https://two.example\");\n    });\n  });\n\n  it(\"marks a successfully connected server with a client instance\", async () => {\n    const fakeClient = { listTools: jest.fn().mockResolvedValue([]) } as any;\n    createImpl.mockResolvedValue(fakeClient);\n\n    let latest: McpServer[] = [];\n    const Capture: React.FC = () => {\n      const servers = useTamboMcpServers();\n      useEffect(() => {\n        latest = servers;\n      }, [servers]);\n      return null;\n    };\n\n    render(\n      <TamboClientContext.Provider\n        value={{\n          client: { baseURL: \"https://api.tambo.co\" } as any,\n          queryClient: new QueryClient(),\n          isUpdatingToken: false,\n        }}\n      >\n        <TamboRegistryProvider mcpServers={[{ url: \"https://ok.example\" }]}>\n          <TamboMcpTokenProvider>\n            <TamboMcpProvider>\n              <Capture />\n            </TamboMcpProvider>\n          </TamboMcpTokenProvider>\n        </TamboRegistryProvider>\n      </TamboClientContext.Provider>,\n    );\n\n    await waitFor(() => {\n      expect(latest.length).toBe(1);\n      expect(\"client\" in latest[0]).toBe(true);\n      expect((latest[0] as any).client).toBe(fakeClient);\n      // no connectionError on connected server\n      expect((latest[0] as any).connectionError).toBeUndefined();\n    });\n  });\n\n  it(\"marks a failed server with a connectionError and no client\", async () => {\n    const boom = new Error(\"boom\");\n    createImpl.mockRejectedValue(boom);\n\n    let latest: McpServer[] = [];\n    const Capture: React.FC = () => {\n      const servers = useTamboMcpServers();\n      useEffect(() => {\n        latest = servers;\n      }, [servers]);\n      return null;\n    };\n\n    render(\n      <TamboClientContext.Provider\n        value={{\n          client: { baseURL: \"https://api.tambo.co\" } as any,\n          queryClient: new QueryClient(),\n          isUpdatingToken: false,\n        }}\n      >\n        <TamboRegistryProvider mcpServers={[{ url: \"https://fail.example\" }]}>\n          <TamboMcpTokenProvider>\n            <TamboMcpProvider>\n              <Capture />\n            </TamboMcpProvider>\n          </TamboMcpTokenProvider>\n        </TamboRegistryProvider>\n      </TamboClientContext.Provider>,\n    );\n\n    await waitFor(() => {\n      expect(latest.length).toBe(1);\n      expect(\"client\" in latest[0]).toBe(false);\n      // @ts-expect-error narrowing at runtime\n      expect(latest[0].connectionError).toBeInstanceOf(Error);\n      // @ts-expect-error narrowing at runtime\n      expect(latest[0].connectionError?.message).toBe(\"boom\");\n    });\n  });\n});\n"]}
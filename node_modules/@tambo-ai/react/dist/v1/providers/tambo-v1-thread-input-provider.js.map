{"version":3,"file":"tambo-v1-thread-input-provider.js","sourceRoot":"","sources":["../../../src/v1/providers/tambo-v1-thread-input-provider.tsx"],"names":[],"mappings":"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","sourcesContent":["\"use client\";\n\n/**\n * TamboV1ThreadInputProvider - Shared Thread Input Context for v1 API\n *\n * Provides shared input state across all components, enabling features like\n * suggestions to update the input field directly.\n *\n * This mirrors the beta SDK's TamboThreadInputProvider pattern.\n */\n\nimport React, {\n  createContext,\n  useCallback,\n  useContext,\n  useState,\n  type PropsWithChildren,\n} from \"react\";\nimport {\n  useMessageImages,\n  type StagedImage,\n} from \"../../hooks/use-message-images\";\nimport {\n  useTamboMutation,\n  type UseTamboMutationResult,\n} from \"../../hooks/react-query-hooks\";\nimport { useTamboV1SendMessage } from \"../hooks/use-tambo-v1-send-message\";\nimport type { InputMessage } from \"../types/message\";\nimport { useStreamState } from \"./tambo-v1-stream-context\";\n\n// Error messages for various input-related error scenarios.\n// TODO: Reintroduce explicit `NETWORK` and `SERVER` keys once `submit()` maps\n// failures into a small, stable set of user-facing error codes (at minimum:\n// connectivity failures vs non-2xx responses).\nexport const INPUT_ERROR_MESSAGES = {\n  EMPTY: \"Message cannot be empty\",\n  VALIDATION: \"Invalid message format\",\n} as const;\n\nfunction stagedImageToResourceContent(\n  image: StagedImage,\n): InputMessage[\"content\"][number] {\n  if (!image.dataUrl.startsWith(\"data:\")) {\n    throw new Error(INPUT_ERROR_MESSAGES.VALIDATION);\n  }\n\n  const commaIndex = image.dataUrl.indexOf(\",\");\n  if (commaIndex === -1) {\n    throw new Error(INPUT_ERROR_MESSAGES.VALIDATION);\n  }\n\n  const header = image.dataUrl.slice(\"data:\".length, commaIndex);\n  const [mimeType, ...params] = header.split(\";\");\n  const isBase64 = params.includes(\"base64\");\n\n  if (mimeType !== image.type || !isBase64) {\n    throw new Error(INPUT_ERROR_MESSAGES.VALIDATION);\n  }\n\n  return {\n    type: \"resource\",\n    resource: {\n      name: image.name,\n      mimeType: image.type,\n      // Shared.Resource.blob expects base64-encoded data; this is the base64\n      // payload from the `data:` URL.\n      blob: image.dataUrl.slice(commaIndex + 1),\n    },\n  };\n}\n\n/**\n * Options for submitting a message\n */\nexport interface SubmitOptions {\n  /**\n   * Enable debug logging for the stream\n   */\n  debug?: boolean;\n}\n\n/**\n * Context props for thread input state\n */\nexport interface TamboV1ThreadInputContextProps extends Omit<\n  UseTamboMutationResult<\n    { threadId: string | undefined },\n    Error,\n    SubmitOptions | undefined\n  >,\n  \"mutate\" | \"mutateAsync\"\n> {\n  /** Current value of the input field */\n  value: string;\n\n  /**\n   * Function to update the input value\n   * @param value - New value for the input field\n   */\n  setValue: React.Dispatch<React.SetStateAction<string>>;\n\n  /**\n   * Function to submit the current input value\n   * @param options - Submission options\n   * @returns Promise with the threadId\n   */\n  submit: (\n    options?: SubmitOptions,\n  ) => Promise<{ threadId: string | undefined }>;\n\n  /** Currently staged images */\n  images: StagedImage[];\n\n  /** Add a single image */\n  addImage: (file: File) => Promise<void>;\n\n  /** Add multiple images */\n  addImages: (files: File[]) => Promise<void>;\n\n  /** Remove an image by id */\n  removeImage: (id: string) => void;\n\n  /** Clear all staged images */\n  clearImages: () => void;\n\n  /** Current thread ID being used for input */\n  threadId: string | undefined;\n\n  /**\n   * Set the thread ID for input submission.\n   * If not set, a new thread will be created on submit.\n   */\n  setThreadId: React.Dispatch<React.SetStateAction<string | undefined>>;\n}\n\n/**\n * Context for thread input state.\n * @internal\n */\nexport const TamboV1ThreadInputContext = createContext<\n  TamboV1ThreadInputContextProps | undefined\n>(undefined);\n\n/**\n * Provider that manages shared thread input state across all components.\n *\n * This ensures that useTamboV1ThreadInput, useTamboV1Suggestions, and other components\n * all share the same input state.\n * @param props - Provider props\n * @param props.children - Child components\n * @returns Thread input context provider\n */\nexport function TamboV1ThreadInputProvider({ children }: PropsWithChildren) {\n  const [inputValue, setInputValue] = useState(\"\");\n  const [threadId, setThreadId] = useState<string | undefined>(undefined);\n  const imageState = useMessageImages();\n  const streamState = useStreamState();\n\n  // Use the current thread from stream state if no explicit threadId is set\n  const inheritedThreadId = streamState.currentThreadId ?? undefined;\n  const effectiveThreadId = threadId ?? inheritedThreadId;\n  const shouldAdoptThreadId =\n    threadId === undefined && inheritedThreadId === undefined;\n  const sendMessage = useTamboV1SendMessage(effectiveThreadId);\n\n  const submitFn = useCallback(\n    async (\n      options?: SubmitOptions,\n    ): Promise<{ threadId: string | undefined }> => {\n      const trimmedValue = inputValue.trim();\n\n      // Check if we have content to send\n      if (!trimmedValue && imageState.images.length === 0) {\n        throw new Error(INPUT_ERROR_MESSAGES.EMPTY);\n      }\n\n      const content: InputMessage[\"content\"] = [];\n\n      if (trimmedValue) {\n        content.push({ type: \"text\", text: trimmedValue });\n      }\n\n      for (const image of imageState.images) {\n        content.push(stagedImageToResourceContent(image));\n      }\n\n      const result = await sendMessage.mutateAsync({\n        message: {\n          role: \"user\",\n          content,\n        },\n        debug: options?.debug,\n      });\n\n      // Clear input and images after successful submission\n      setInputValue(\"\");\n      imageState.clearImages();\n\n      // Update threadId if a new thread was created\n      if (result.threadId && shouldAdoptThreadId) {\n        setThreadId(result.threadId);\n      }\n\n      return result;\n    },\n    // `stagedImageToResourceContent` is a pure module-level helper (not a hook value).\n    [inputValue, imageState, sendMessage, shouldAdoptThreadId],\n  );\n\n  const {\n    mutateAsync: submitAsync,\n    mutate: _unusedSubmit,\n    ...mutationState\n  } = useTamboMutation({\n    mutationFn: submitFn,\n  });\n\n  const contextValue: TamboV1ThreadInputContextProps = {\n    ...mutationState,\n    value: inputValue,\n    setValue: setInputValue,\n    submit: submitAsync,\n    images: imageState.images,\n    addImage: imageState.addImage,\n    addImages: imageState.addImages,\n    removeImage: imageState.removeImage,\n    clearImages: imageState.clearImages,\n    threadId: effectiveThreadId,\n    setThreadId,\n  };\n\n  return (\n    <TamboV1ThreadInputContext.Provider value={contextValue}>\n      {children}\n    </TamboV1ThreadInputContext.Provider>\n  );\n}\n\n/**\n * Hook to access the shared thread input state.\n *\n * All components using this hook share the same input state, enabling\n * features like suggestions to update the input field directly.\n * @returns The shared thread input context\n * @throws {Error} If used outside TamboV1ThreadInputProvider\n * @example\n * ```tsx\n * function ChatInput() {\n *   const { value, setValue, submit, isPending } = useTamboV1ThreadInput();\n *\n *   return (\n *     <form onSubmit={(e) => { e.preventDefault(); submit(); }}>\n *       <input\n *         value={value}\n *         onChange={(e) => setValue(e.target.value)}\n *         disabled={isPending}\n *       />\n *       <button type=\"submit\" disabled={isPending}>Send</button>\n *     </form>\n *   );\n * }\n * ```\n */\nexport function useTamboV1ThreadInput(): TamboV1ThreadInputContextProps {\n  const context = useContext(TamboV1ThreadInputContext);\n  if (!context) {\n    throw new Error(\n      \"useTamboV1ThreadInput must be used within TamboV1ThreadInputProvider\",\n    );\n  }\n  return context;\n}\n"]}
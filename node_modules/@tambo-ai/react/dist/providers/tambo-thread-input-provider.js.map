{"version":3,"file":"tambo-thread-input-provider.js","sourceRoot":"","sources":["../../src/providers/tambo-thread-input-provider.tsx"],"names":[],"mappings":"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","sourcesContent":["\"use client\";\nimport React, {\n  createContext,\n  PropsWithChildren,\n  useCallback,\n  useContext,\n  useState,\n} from \"react\";\nimport {\n  useTamboMutation,\n  UseTamboMutationResult,\n} from \"../hooks/react-query-hooks\";\nimport { StagedImage, useMessageImages } from \"../hooks/use-message-images\";\nimport { useTamboMcpServers } from \"../mcp/tambo-mcp-provider\";\nimport { ThreadInputError } from \"../model/thread-input-error\";\nimport { validateInput } from \"../model/validate-input\";\nimport { buildMessageContent } from \"../util/message-builder\";\nimport {\n  extractResourceUris,\n  resolveResourceContents,\n} from \"../util/resource-content-resolver\";\nimport { useTamboInteractable } from \"./tambo-interactable-provider\";\nimport { useTamboRegistry } from \"./tambo-registry-provider\";\nimport { useTamboThread } from \"./tambo-thread-provider\";\n\n/**\n * Error messages for various input-related error scenarios\n * These messages are used to provide user-friendly error feedback\n * @readonly\n */\nexport const INPUT_ERROR_MESSAGES = {\n  EMPTY: \"Message cannot be empty\",\n  NETWORK: \"Network error. Please check your connection\",\n  SERVER: \"Server error. Please try again\",\n  VALIDATION: \"Invalid message format\",\n} as const;\n\nexport interface TamboThreadInputContextProps extends Omit<\n  UseTamboMutationResult<\n    void,\n    Error,\n    | {\n        contextKey?: string;\n        streamResponse?: boolean;\n        forceToolChoice?: string;\n        additionalContext?: Record<string, any>;\n      }\n    | undefined\n  >,\n  \"mutate\" | \"mutateAsync\"\n> {\n  /** Current value of the input field */\n  value: string;\n  /**\n   * Function to update the input value\n   * @param value - New value for the input field\n   */\n  setValue: (value: React.SetStateAction<string>) => void;\n  /**\n   * Function to submit the current input value\n   * @param options - Submission options\n   */\n  submit: (options?: {\n    streamResponse?: boolean;\n    forceToolChoice?: string;\n    additionalContext?: Record<string, any>;\n    resourceNames?: Record<string, string>;\n  }) => Promise<void>;\n  /** Currently staged images */\n  images: StagedImage[];\n  /** Add a single image */\n  addImage: (file: File) => Promise<void>;\n  /** Add multiple images */\n  addImages: (files: File[]) => Promise<void>;\n  /** Remove an image by id */\n  removeImage: (id: string) => void;\n  /** Clear all staged images */\n  clearImages: () => void;\n}\n\nexport const TamboThreadInputContext = createContext<\n  TamboThreadInputContextProps | undefined\n>(undefined);\n\n/**\n * Provider that manages shared thread input state across all components\n * This ensures that useTamboThreadInput, useTamboSuggestions, and components\n * all share the same input state\n * @param props - The props for the TamboThreadInputProvider\n * @param props.children - The children to render.\n * @returns The thread input context\n */\nexport const TamboThreadInputProvider: React.FC<PropsWithChildren> = ({\n  children,\n}) => {\n  const { thread, sendThreadMessage, contextKey } = useTamboThread();\n  const [inputValue, setInputValue] = useState(\"\");\n  const imageState = useMessageImages();\n  const mcpServers = useTamboMcpServers();\n  const { resourceSource } = useTamboRegistry();\n  const { clearInteractableSelections } = useTamboInteractable();\n  const submit = useCallback(\n    async ({\n      streamResponse,\n      forceToolChoice,\n      additionalContext,\n      resourceNames = {},\n    }: {\n      streamResponse?: boolean;\n      forceToolChoice?: string;\n      additionalContext?: Record<string, any>;\n      resourceNames?: Record<string, string>;\n    } = {}) => {\n      // Validate text input if present\n      if (inputValue?.trim()) {\n        const validation = validateInput(inputValue);\n        if (!validation.isValid) {\n          throw new ThreadInputError(\n            `Cannot submit message: ${validation.error ?? INPUT_ERROR_MESSAGES.VALIDATION}`,\n            { cause: validation.error },\n          );\n        }\n      }\n\n      // Check if we have content to send\n      if (!inputValue.trim() && imageState.images.length === 0) {\n        throw new ThreadInputError(INPUT_ERROR_MESSAGES.EMPTY, {\n          cause: \"No text or images to send\",\n        });\n      }\n\n      // Extract resource URIs from the input text and resolve content for client-side resources\n      // (registry and client-side MCP servers). Internal Tambo server resources are skipped\n      // since the backend can resolve them.\n      const resourceUris = extractResourceUris(inputValue);\n      const resolvedContent = await resolveResourceContents(\n        resourceUris,\n        mcpServers,\n        resourceSource ?? undefined,\n      );\n\n      // Build message content with text, images, resource names, and resolved content\n      const messageContent = buildMessageContent(\n        inputValue,\n        imageState.images,\n        resourceNames,\n        resolvedContent,\n      );\n\n      try {\n        await sendThreadMessage(inputValue || \"Image message\", {\n          threadId: thread.id,\n          contextKey,\n          streamResponse: streamResponse,\n          forceToolChoice: forceToolChoice,\n          additionalContext: additionalContext,\n          content: messageContent,\n        });\n        clearInteractableSelections();\n      } catch (error: unknown) {\n        // Handle image-related errors with friendly messages\n        if (imageState.images.length > 0) {\n          const errorMessage =\n            error instanceof Error ? error.message.toLowerCase() : \"\";\n\n          // Backend not yet supporting image content type\n          if (errorMessage.includes(\"unknown content part type: image\")) {\n            throw new ThreadInputError(\n              \"Image attachments are not yet supported by the backend. This feature is coming soon.\",\n              { cause: error },\n            );\n          }\n\n          // Handle specific model vision support errors\n          // OpenAI errors\n          if (\n            errorMessage.includes(\n              \"does not support image message content types\",\n            ) ||\n            (errorMessage.includes(\"invalid model\") &&\n              errorMessage.includes(\n                \"image_url is only supported by certain models\",\n              ))\n          ) {\n            throw new ThreadInputError(\n              \"This model doesn't support images. Please use GPT-4o, GPT-4 Turbo, or other vision-capable models.\",\n              { cause: error },\n            );\n          }\n\n          // Anthropic Claude errors\n          if (\n            errorMessage.includes(\"does not support image\") ||\n            errorMessage.includes(\"vision not supported\")\n          ) {\n            throw new ThreadInputError(\n              \"This Claude model doesn't support images. Please use Claude 3.5 Sonnet, Claude 3 Opus, or other vision-capable models.\",\n              { cause: error },\n            );\n          }\n\n          // Generic image/vision errors\n          if (\n            errorMessage.includes(\"image\") ||\n            errorMessage.includes(\"vision\")\n          ) {\n            throw new ThreadInputError(\n              \"This model doesn't support image attachments. Please use a vision-capable model.\",\n              { cause: error },\n            );\n          }\n        }\n\n        throw error;\n      }\n\n      // Clear text after successful submission\n      setInputValue(\"\");\n    },\n    [\n      inputValue,\n      sendThreadMessage,\n      thread.id,\n      contextKey,\n      imageState,\n      mcpServers,\n      resourceSource,\n      clearInteractableSelections,\n    ],\n  );\n\n  const {\n    mutateAsync: submitAsync,\n    mutate: _unusedSubmit,\n    ...mutationState\n  } = useTamboMutation({\n    mutationFn: submit,\n  });\n\n  const value = {\n    ...mutationState,\n    value: inputValue,\n    setValue: setInputValue,\n    submit: submitAsync,\n    images: imageState.images,\n    addImage: imageState.addImage,\n    addImages: imageState.addImages,\n    removeImage: imageState.removeImage,\n    clearImages: imageState.clearImages,\n  };\n\n  return (\n    <TamboThreadInputContext.Provider value={value}>\n      {children}\n    </TamboThreadInputContext.Provider>\n  );\n};\n\n/**\n * Hook to access the shared thread input state\n * contextKey parameter is not passed here anymore. Instead, use the contextKey prop in the TamboProvider.\n * @returns The thread input context\n */\nexport const useTamboThreadInput = () => {\n  const context = useContext(TamboThreadInputContext);\n  if (!context) {\n    throw new Error(\n      \"useTamboThreadInput must be used within a TamboThreadInputProvider\",\n    );\n  }\n\n  return context;\n};\n"]}
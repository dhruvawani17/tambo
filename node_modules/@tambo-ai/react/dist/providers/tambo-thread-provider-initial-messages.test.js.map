{"version":3,"file":"tambo-thread-provider-initial-messages.test.js","sourceRoot":"","sources":["../../src/providers/tambo-thread-provider-initial-messages.test.tsx"],"names":[],"mappings":"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","sourcesContent":["import { advanceStream } from \"@tambo-ai/typescript-sdk\";\nimport { act, renderHook } from \"@testing-library/react\";\nimport React from \"react\";\nimport { TamboTool } from \"..\";\nimport {\n  GenerationStage,\n  TamboThreadMessage,\n} from \"../model/generate-component-response\";\nimport {\n  TamboClientContext,\n  useTamboClient,\n  useTamboQueryClient,\n} from \"./tambo-client-provider\";\nimport { TamboContextHelpersProvider } from \"./tambo-context-helpers-provider\";\nimport { TamboMcpTokenProvider } from \"./tambo-mcp-token-provider\";\nimport { TamboRegistryProvider } from \"./tambo-registry-provider\";\nimport { TamboThreadProvider, useTamboThread } from \"./tambo-thread-provider\";\nimport type { PartialTamboAI } from \"../testing/types\";\n\n// Mock crypto.randomUUID\nObject.defineProperty(global, \"crypto\", {\n  value: {\n    randomUUID: jest.fn().mockReturnValue(\"test-uuid\"),\n  },\n});\n\n// Mock the required providers\njest.mock(\"./tambo-client-provider\", () => {\n  return {\n    useTamboClient: jest.fn(),\n    useTamboQueryClient: jest.fn(),\n    TamboClientContext: React.createContext(undefined),\n  };\n});\njest.mock(\"@tambo-ai/typescript-sdk\", () => ({\n  advanceStream: jest.fn(),\n}));\n\n// Test utilities\nconst createMockMessage = (\n  overrides: Partial<TamboThreadMessage> = {},\n): TamboThreadMessage => ({\n  id: \"test-message-1\",\n  content: [{ type: \"text\", text: \"Hello\" }],\n  role: \"user\",\n  threadId: \"test-thread-1\",\n  createdAt: new Date().toISOString(),\n  componentState: {},\n  ...overrides,\n});\n\n// Test wrapper\nconst createWrapper = (\n  initialMessages: TamboThreadMessage[] = [],\n  tools: TamboTool[] = [],\n) => {\n  const TestWrapper = ({ children }: { children: React.ReactNode }) => {\n    const client = useTamboClient();\n    const queryClient = useTamboQueryClient();\n\n    return (\n      <TamboClientContext.Provider\n        value={{\n          client,\n          queryClient,\n          isUpdatingToken: false,\n        }}\n      >\n        <TamboRegistryProvider components={[]} tools={tools}>\n          <TamboContextHelpersProvider>\n            <TamboMcpTokenProvider>\n              <TamboThreadProvider\n                initialMessages={initialMessages}\n                autoGenerateThreadName={false}\n              >\n                {children}\n              </TamboThreadProvider>\n            </TamboMcpTokenProvider>\n          </TamboContextHelpersProvider>\n        </TamboRegistryProvider>\n      </TamboClientContext.Provider>\n    );\n  };\n  TestWrapper.displayName = \"TestWrapper\";\n  return TestWrapper;\n};\n\ndescribe(\"TamboThreadProvider with initial messages\", () => {\n  const mockClient: PartialTamboAI = {\n    beta: {\n      threads: {\n        advance: jest.fn(),\n        advanceByID: jest.fn(),\n        cancel: jest.fn(),\n        messages: {\n          create: jest.fn(),\n        },\n      },\n    },\n  };\n\n  beforeEach(() => {\n    jest.clearAllMocks();\n    (useTamboClient as jest.Mock).mockReturnValue(mockClient);\n    // Provide a minimal mock for the query client used by the provider\n    const mockQueryClient = {\n      setQueryData: jest.fn(),\n      invalidateQueries: jest.fn(),\n    };\n    (useTamboQueryClient as jest.Mock).mockReturnValue(mockQueryClient);\n    (advanceStream as jest.Mock).mockImplementation(async function* () {\n      yield {\n        responseMessageDto: {\n          id: \"response-1\",\n          role: \"assistant\",\n          content: [{ type: \"text\", text: \"Hello back!\" }],\n          threadId: \"new-thread-id\",\n          componentState: {},\n          createdAt: new Date().toISOString(),\n        },\n        generationStage: GenerationStage.COMPLETE,\n      };\n    });\n  });\n\n  it(\"should initialize with empty messages when no initial messages provided\", () => {\n    const { result } = renderHook(() => useTamboThread(), {\n      wrapper: createWrapper(),\n    });\n\n    expect(result.current.thread.messages).toEqual([]);\n  });\n\n  it(\"should initialize with provided initial messages\", () => {\n    const initialMessages: TamboThreadMessage[] = [\n      createMockMessage({\n        id: \"initial-1\",\n        role: \"system\",\n        content: [{ type: \"text\", text: \"You are a helpful assistant.\" }],\n      }),\n      createMockMessage({\n        id: \"initial-2\",\n        role: \"user\",\n        content: [{ type: \"text\", text: \"Hello!\" }],\n      }),\n    ];\n\n    const { result } = renderHook(() => useTamboThread(), {\n      wrapper: createWrapper(initialMessages),\n    });\n\n    expect(result.current.thread.messages).toHaveLength(2);\n    expect(result.current.thread.messages[0].content[0].text).toBe(\n      \"You are a helpful assistant.\",\n    );\n    expect(result.current.thread.messages[1].content[0].text).toBe(\"Hello!\");\n  });\n\n  it(\"should include initial messages when sending a message to a new thread\", async () => {\n    const initialMessages: TamboThreadMessage[] = [\n      createMockMessage({\n        id: \"initial-1\",\n        role: \"system\",\n        content: [{ type: \"text\", text: \"You are a helpful assistant.\" }],\n      }),\n    ];\n\n    const { result } = renderHook(() => useTamboThread(), {\n      wrapper: createWrapper(initialMessages),\n    });\n\n    await act(async () => {\n      await result.current.sendThreadMessage(\"Test message\");\n    });\n\n    // Check that advanceStream was called with initial messages\n    expect(advanceStream).toHaveBeenCalledWith(\n      mockClient,\n      expect.objectContaining({\n        initialMessages: [\n          {\n            content: [{ type: \"text\", text: \"You are a helpful assistant.\" }],\n            role: \"system\",\n            additionalContext: undefined,\n          },\n        ],\n      }),\n      undefined,\n    );\n  });\n\n  it(\"should not include initial messages when sending to an existing thread\", async () => {\n    const initialMessages: TamboThreadMessage[] = [\n      createMockMessage({\n        id: \"initial-1\",\n        role: \"system\",\n        content: [{ type: \"text\", text: \"You are a helpful assistant.\" }],\n      }),\n    ];\n\n    const { result } = renderHook(() => useTamboThread(), {\n      wrapper: createWrapper(initialMessages),\n    });\n\n    // Switch to an existing thread first\n    await act(async () => {\n      result.current.switchCurrentThread(\"existing-thread-id\", false);\n    });\n\n    await act(async () => {\n      await result.current.sendThreadMessage(\"Test message\");\n    });\n\n    // Check that advanceStream was called without initial messages\n    expect(advanceStream).toHaveBeenCalledWith(\n      mockClient,\n      expect.not.objectContaining({\n        initialMessages: expect.anything(),\n      }),\n      \"existing-thread-id\",\n    );\n  });\n\n  it(\"should reset to initial messages when starting a new thread\", () => {\n    const initialMessages: TamboThreadMessage[] = [\n      createMockMessage({\n        id: \"initial-1\",\n        role: \"system\",\n        content: [{ type: \"text\", text: \"You are a helpful assistant.\" }],\n      }),\n    ];\n\n    const { result } = renderHook(() => useTamboThread(), {\n      wrapper: createWrapper(initialMessages),\n    });\n\n    // Switch to an existing thread\n    act(() => {\n      result.current.switchCurrentThread(\"existing-thread-id\", false);\n    });\n\n    // Start a new thread\n    act(() => {\n      result.current.startNewThread();\n    });\n\n    expect(result.current.thread.messages).toHaveLength(1);\n    expect(result.current.thread.messages[0].content[0].text).toBe(\n      \"You are a helpful assistant.\",\n    );\n  });\n\n  it(\"should not include initial messages in tool response when first message triggers a tool\", async () => {\n    const initialMessages: TamboThreadMessage[] = [\n      createMockMessage({\n        id: \"initial-1\",\n        role: \"system\",\n        content: [{ type: \"text\", text: \"You are a helpful assistant.\" }],\n      }),\n    ];\n\n    // Create a test tool with JSON schema format\n    const testTool = {\n      name: \"testTool\",\n      description: \"A test tool\",\n      tool: jest.fn().mockResolvedValue({ result: \"success\" }),\n      inputSchema: {\n        type: \"object\" as const,\n        properties: {},\n      },\n      outputSchema: {\n        type: \"object\" as const,\n        properties: {\n          result: { type: \"string\" as const },\n        },\n      },\n    };\n\n    // Mock advanceStream to simulate a tool call on first message\n    let advanceStreamCallCount = 0;\n    (advanceStream as jest.Mock).mockImplementation(async function* () {\n      advanceStreamCallCount++;\n\n      if (advanceStreamCallCount === 1) {\n        // First call: user message triggers a tool\n        yield {\n          responseMessageDto: {\n            id: \"response-1\",\n            role: \"assistant\",\n            content: [],\n            threadId: \"new-thread-id\",\n            componentState: {},\n            createdAt: new Date().toISOString(),\n            tool_call_id: \"tool-call-1\",\n            toolCallRequest: {\n              toolName: \"testTool\",\n              args: {},\n            },\n          },\n          generationStage: GenerationStage.FETCHING_CONTEXT,\n        };\n      } else {\n        // Second call: tool response should NOT have initialMessages\n        yield {\n          responseMessageDto: {\n            id: \"response-2\",\n            role: \"assistant\",\n            content: [{ type: \"text\", text: \"Tool executed successfully\" }],\n            threadId: \"new-thread-id\",\n            componentState: {},\n            createdAt: new Date().toISOString(),\n          },\n          generationStage: GenerationStage.COMPLETE,\n        };\n      }\n    });\n\n    const { result } = renderHook(() => useTamboThread(), {\n      wrapper: createWrapper(initialMessages, [testTool]),\n    });\n\n    await act(async () => {\n      await result.current.sendThreadMessage(\"Test message that triggers tool\");\n    });\n\n    // First call should have initialMessages\n    expect(advanceStream).toHaveBeenNthCalledWith(\n      1,\n      mockClient,\n      expect.objectContaining({\n        initialMessages: expect.any(Array),\n      }),\n      undefined,\n    );\n\n    // Second call (tool response) should NOT have initialMessages\n    expect(advanceStream).toHaveBeenNthCalledWith(\n      2,\n      mockClient,\n      expect.objectContaining({\n        messageToAppend: expect.objectContaining({\n          role: \"tool\",\n        }),\n      }),\n      \"new-thread-id\",\n    );\n\n    // Verify that the second call does NOT contain initialMessages\n    const secondCallParams = (advanceStream as jest.Mock).mock.calls[1][1];\n    expect(secondCallParams.initialMessages).toBeUndefined();\n  });\n});\n"]}
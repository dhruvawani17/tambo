"use strict";
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
exports.renderComponentIntoMessage = renderComponentIntoMessage;
const partial_json_1 = require("partial-json");
const react_1 = __importDefault(require("react"));
const use_current_message_1 = require("../hooks/use-current-message");
const schema_1 = require("../schema");
const is_promise_1 = require("../util/is-promise");
const registry_1 = require("../util/registry");
/**
 * Generate a message that has a component rendered into it, if the message
 * came with one.
 * @param message - The message that may contain a component
 * @param componentList - the list of available components
 * @returns The updated message with the component rendered into it
 */
function renderComponentIntoMessage(message, componentList) {
    if (!message.component?.componentName) {
        throw new Error("Component not found");
    }
    const parsedProps = (0, partial_json_1.parse)(JSON.stringify(message.component.props));
    const registeredComponent = (0, registry_1.getComponentFromRegistry)(message.component.componentName, componentList);
    let validatedProps = parsedProps;
    if ((0, schema_1.isStandardSchema)(registeredComponent.props)) {
        const result = registeredComponent.props["~standard"].validate(parsedProps);
        // Standard Schema validate() returns { value: T } on success or { issues: [...] } on failure
        // Async validation is not supported for component rendering
        if ((0, is_promise_1.isPromise)(result)) {
            throw new Error("Async schema validation is not supported for component props");
        }
        if ("value" in result) {
            validatedProps = result.value;
        }
        else {
            // Validation failed - throw with first issue message
            const issueMessage = result.issues?.[0]?.message ?? "Schema validation failed";
            throw new Error(`Component props validation failed: ${issueMessage}`);
        }
    }
    const renderedComponent = react_1.default.createElement(registeredComponent.component, validatedProps);
    // Create the full message object first so we can pass it to the provider
    const fullMessage = {
        ...message,
        component: {
            ...message.component,
            props: validatedProps,
        },
    };
    const wrappedComponent = (0, use_current_message_1.wrapWithTamboMessageProvider)(renderedComponent, fullMessage);
    return {
        ...fullMessage,
        renderedComponent: wrappedComponent,
    };
}
//# sourceMappingURL=generate-component.js.map
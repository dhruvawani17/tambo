"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.advanceStream = advanceStream;
async function advanceStream(client, body, threadId, options) {
    const MAX_REQUEST_RETRIES = 2;
    let requestRetryCount = 0;
    while (true) {
        try {
            const responsePromise = client.post(`/threads${threadId ? `/${threadId}` : ''}/advancestream`, {
                body,
                ...options,
                headers: {
                    ...options?.headers,
                    Accept: 'text/event-stream',
                },
            });
            const response = await responsePromise.asResponse();
            return handleStreamResponse(response);
        }
        catch (error) {
            if (requestRetryCount < MAX_REQUEST_RETRIES) {
                requestRetryCount++;
                console.warn(`Request failed, attempting retry ${requestRetryCount}/${MAX_REQUEST_RETRIES}`);
                continue;
            }
            throw error;
        }
    }
}
async function* handleStreamResponse(response) {
    const decoder = new TextDecoder();
    const MAX_CHUNK_RETRIES = 5;
    let chunkRetryCount = 0;
    const reader = response.body.getReader();
    while (true) {
        try {
            const { done, value: chunk } = await reader.read();
            if (done)
                break;
            const text = decoder.decode(chunk);
            const messages = text.split('\n').filter((msg) => msg.trim());
            for (const msg of messages) {
                if (msg === 'data: DONE') {
                    continue;
                }
                if (msg.startsWith('error: ')) {
                    throw new Error(msg.slice(7));
                }
                const jsonStr = msg.startsWith('data: ') ? msg.slice(6) : msg;
                if (!jsonStr) {
                    continue;
                }
                try {
                    yield JSON.parse(jsonStr);
                    chunkRetryCount = 0;
                }
                catch (e) {
                    if (chunkRetryCount < MAX_CHUNK_RETRIES) {
                        chunkRetryCount++;
                        console.warn(`Failed to parse JSON chunk, skipping. Attempt ${chunkRetryCount}/${MAX_CHUNK_RETRIES}`);
                        continue;
                    }
                    throw new Error('Failed to parse JSON after multiple chunks.');
                }
            }
        }
        catch (error) {
            reader.releaseLock();
            throw error;
        }
    }
}
//# sourceMappingURL=advance-stream.js.map